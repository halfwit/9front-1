<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv=Content-Type content="text/html; charset=utf8">
<title>Security in Plan 9</title>
</meta>
</head>
<body>
<p style="margin-top: 0; margin-bottom: 0.50in"></p>
<p style="margin-top: 0; margin-bottom: 0.21in"></p>

<p style="line-height: 1.4em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: center;">
<span style="font-size: 12pt"><b>Security in Plan 9</b></span></p>
<p style="margin-top: 0; margin-bottom: 0.21in"></p>

<p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.4em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: center;">
<span style="font-size: 10pt"><i>Russ Cox, MIT LCS</i></span></p>
<p style="line-height: 1.4em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: center;">
<span style="font-size: 10pt"><i>Eric Grosse, Bell Labs</i></span></p>
<p style="line-height: 1.4em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: center;">
<span style="font-size: 10pt"><i>Rob Pike, Bell Labs</i></span></p>
<p style="line-height: 1.4em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: center;">
<span style="font-size: 10pt"><i>Dave Presotto, Avaya Labs and Bell Labs</i></span></p>
<p style="line-height: 1.4em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: center;">
<span style="font-size: 10pt"><i>Sean Quinlan, Bell Labs</i></span></p>
<p style="line-height: 1.4em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: center;">
<span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt"><tt>{rsc,ehg,rob,presotto,seanq}@plan9.bell-labs.com</tt></span><span style="font-size: 10pt"><i></i></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="margin-top: 0; margin-bottom: 0.33in"></p>
<p style="line-height: 1.4em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: center;">
<span style="font-size: 10pt"><i>ABSTRACT</i></span></p>
<p style="margin-top: 0; margin-bottom: 0.19in"></p>
<p style="line-height: 1.2em; margin-left: 1.50in; text-indent: 0.35in; margin-right: 1.50in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The security architecture of the Plan 9™
operating system has recently been redesigned
to address some technical shortcomings.
This redesign provided an opportunity also to make the system more
convenient to use securely.
Plan 9 has thus improved in two ways not usually seen together:
it has become more secure
</span><span style="font-size: 10pt"><i>and</i></span><span style="font-size: 10pt">
easier to use.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.50in; text-indent: 0.50in; margin-right: 1.50in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The central component of the new architecture is a per-user
self-contained agent called
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">.
</span><span style="font-size: 10pt"><tt>Factotum</tt></span><span style="font-size: 10pt">
securely holds a
copy of the user&rsquo;s keys and negotiates authentication protocols, on
behalf of the user, with secure services around the network.
Concentrating security code in a single program offers several
advantages including: ease of update or repair to broken security
software and protocols; the ability to run secure services at a lower
privilege level; uniform management of keys for all services; and an
opportunity to provide single sign on, even to unchanged legacy
applications.
</span><span style="font-size: 10pt"><tt>Factotum</tt></span><span style="font-size: 10pt">
has an unusual architecture: it is implemented
as a Plan 9 file server.
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="margin-top: 0; margin-bottom: 0.50in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>1.
Introduction
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Secure computing systems face two challenges:
first, they must employ sophisticated technology that is difficult to design
and prove correct; and second,
they must be easy for regular people to use.
The question of ease of use is sometimes neglected, but it is essential:
weak but easy-to-use security can be more effective than strong but
difficult-to-use security if it is more likely to be used.
People lock their front doors when they leave the house, knowing
full well that a burglar is capable of picking the lock (or avoiding
the door altogether); yet few would accept the cost and
awkwardness of a bank vault door on the
house even though that might reduce the probability of a robbery.
A related point is that users need a clear model of how the security
operates (if not how it actually provides security) in order to use it
well; for example, the clarity of a lock icon on a web browser
is offset by the confusing and typically insecure
steps for installing X.509 certificates.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The security architecture of the Plan 9
operating system
[Pike95]
has recently been redesigned to make it both more secure
and easier to use.
By
</span><span style="font-size: 10pt"><i>security</i></span><span style="font-size: 10pt">
we mean three things:
first, the business of authenticating users and services;
second, the safe handling, deployment, and use of keys
and other secret information; and
third, the use of encryption and integrity checks
to safeguard communications
from prying eyes.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The old security architecture of Plan 9
had several engineering problems in common with other operating systems.
First, it had an inadequate notion of security domain.
Once a user provided a password to connect to a local file store,
the system required that the same password be used to access all the other file
stores.
That is, the system treated all network services as
belonging to the same security domain. 
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Second, the algorithms and protocols used in authentication,
by nature tricky and difficult to get right, were compiled into the
various applications, kernel modules, and file servers.
Changes and fixes to a security protocol
required that all components using that protocol needed to be recompiled,
or at least relinked, and restarted.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Third, the file transport protocol, 9P
[Pike93],
that forms the core of
the Plan 9 system, had its authentication protocol embedded in its design.
This meant that fixing or changing the authentication used by 9P
required deep changes to the system.
If someone were to find a way to break the protocol, the system would
be wide open and very hard to fix.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">These and a number of lesser problems, combined with a desire
for more widespread use of encryption in the system, spurred us to
rethink the entire security architecture of Plan 9.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The centerpiece of the new architecture is an agent,
called
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">,
that handles the user&rsquo;s keys and negotiates all security
interactions with system services and applications.
Like a trusted assistant with a copy of the owner&rsquo;s keys,
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
does all the negotiation for security and authentication.
Programs no longer need to be compiled with cryptographic
code; instead they communicate with
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
agents
that represent distinct entities in the cryptographic exchange,
such as a user and server of a secure service.
If a security protocol needs to be added, deleted, or modified,
only
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
needs to be updated for all system services
to be kept secure.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Building on
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">,
we modified
secure services in the system to move
user authentication code into
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">;
made authentication a separable component of the file server protocol;
deployed new security protocols;
designed a secure file store,
called
</span><span style="font-size: 10pt"><tt>secstore</tt></span><span style="font-size: 10pt">,
to protect our keys but make them easy to get when they are needed;
designed a new kernel module to support transparent use of 
Transport Layer Security (TLS)
[RFC2246];
and began using encryption for all communications within the system.
The overall architecture is illustrated in Figure 1a.
</span></p><center><table width=60% cellspacing=0 cellpadding=0 border=0><tr height=1>	<td width=1 bgcolor=#000000 />	<td width=10 bgcolor=#000000 />	<td bgcolor=#000000 />	<td width=10 bgcolor=#000000 />	<td width=1 bgcolor=#000000 /></tr><tr height=10>	<td width=1 bgcolor=#000000 />	<td width=10 />	<td />	<td width=10 />	<td width=1 bgcolor=#000000 /></tr>
<tr>
<td width=1 bgcolor=#000000 /><td width=10 /><td>
<p style="margin-top: 0; margin-bottom: 0.02in"></p>

<p style="margin-top: 0; margin-bottom: 0.02in"></p>

<p style="margin-top: 0; margin-bottom: 0.02in"></p>

<center><img src="auth0.png"></center>
</center>
<p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; text-indent: 0.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt">Figure 1a.  Components of the security architecture.
Each box is a (typically) separate machine; each ellipse a process.
<p style="margin-top: 0; margin-bottom: 0.02in"></p>

</span><span style="font-size: 9pt">The ellipses labeled </span><span style="font-size: 9pt"></span><span style="font-size: 9pt"><i>F</i></span><span style="font-size: 9pt"><sub></sub></span><sub><span style="font-size: 6pt"></span><span style="font-size: 6pt"><i>X</i></span><span style="font-size: 6pt"></span><span style="font-size: 9pt"></span></sub><span style="font-size: 9pt"></span><span style="font-size: 9pt">
are
</span><span style="font-size: 9pt"><tt>factotum</tt></span><span style="font-size: 9pt">
processes; those labeled
<p style="margin-top: 0; margin-bottom: 0.02in"></p>

</span><span style="font-size: 9pt"></span><span style="font-size: 9pt"></span><span style="font-size: 9pt"><i>P</i></span><span style="font-size: 9pt"><sub></sub></span><sub><span style="font-size: 6pt"></span><span style="font-size: 6pt"><i>X</i></span><span style="font-size: 6pt"></span><span style="font-size: 9pt"></span></sub><span style="font-size: 9pt"></span><span style="font-size: 9pt">
are the pieces and proxies of a distributed program.
The authentication server is one of several repositories for users&rsquo; security information
that
</span><span style="font-size: 9pt"><tt>factotum</tt></span><span style="font-size: 9pt">
processes consult as required.
</span><span style="font-size: 9pt"><tt>Secstore</tt></span><span style="font-size: 9pt">
is a shared resource for storing private information such as keys;
</span><span style="font-size: 9pt"><tt>factotum</tt></span><span style="font-size: 9pt">
consults it for the user during bootstrap.
</span></p><p style="margin-top: 0; margin-bottom: 0.14in"></p>
<p style="margin-top: 0; margin-bottom: 0.02in"></p>

</td>
<td width=10 /><td width=1 bgcolor=#000000 />
</tr>
<tr height=10><td width=1 bgcolor=#000000 />	<td width=10 /><td /><td width=10 />	<td width=1 bgcolor=#000000 /></tr><tr height=1>	<td width=1 bgcolor=#000000 />	<td width=10 bgcolor=#000000 />	<td bgcolor=#000000 />	<td width=10 bgcolor=#000000 />	<td width=1 bgcolor=#000000 /></tr>
</table></center>
<p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Secure protocols and algorithms are well understood
and are usually not the weakest link in a system&rsquo;s security.
In practice, most security problems arise from buggy servers,
confusing software, or administrative oversights.
It is these practical problems that we are addressing.
Although this paper describes the algorithms and protocols we are using,
they are included mainly for concreteness.
Our main intent is to present a simple security architecture built
upon a small trusted code base that is easy to verify (whether by manual or
automatic means), easy to understand, and easy to use.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Although it is a subjective assessment,
we believe we have achieved our goal of ease of use.
That we have achieved
our goal of improved security is supported by our plan to
move our currently private computing environment onto the Internet
outside the corporate firewall.
The rest of this paper explains the architecture and how it is used,
to explain why a system that is easy to use securely is also safe
enough to run in the open network.
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>2.
An Agent for Security
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">One of the primary reasons for the redesign of the Plan 9
security infrastructure was to remove the authentication
method both from the applications and from the kernel.
Cryptographic code
is large and intricate, so it should
be packaged as a separate component that can be repaired or
modified without altering or even relinking applications
and services that depend on it.
If a security protocol is broken, it should be trivial to repair,
disable, or replace it on the fly.
Similarly, it should be possible for multiple programs to use
a common security protocol without embedding it in each program.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Some systems use dynamically linked libraries (DLLs) to address these configuration issues.
The problem with this approach is that it leaves
security code in the same address space as the program using it.
The interactions between the program and the DLL
can therefore accidentally or deliberately violate the interface,
weakening security.
Also, a program using a library to implement secure services
must run at a privilege level necessary to provide the service;
separating the security to a different program makes it possible
to run the services at a weaker privilege level, isolating the
privileged code to a single, more trustworthy component.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Following the lead of the SSH agent
[Ylon96],
we give each user
an agent process responsible
for holding and using the user&rsquo;s keys.
The agent program is called
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
because of its similarity to the proverbial servant with the
power to act on behalf of his master because he holds the
keys to all the master&rsquo;s possessions.  It is essential that
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
keep the keys secret and use them only in the owner&rsquo;s interest.
Later we&rsquo;ll discuss some changes to the kernel to reduce the possibility of
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
leaking information inadvertently.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"></span><span style="font-size: 10pt"><tt>Factotum</tt></span><span style="font-size: 10pt">
is implemented, like most Plan 9 services, as a file server.
It is conventionally mounted upon the directory
</span><span style="font-size: 10pt"><tt>/mnt/factotum</tt></span><span style="font-size: 10pt">,
and the files it serves there are analogous to virtual devices that provide access to,
and control of, the services of the
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">.
The next few sections describe the design of
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
and how it operates with the other pieces of Plan 9 to provide
security services.
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>2.1.
Logging in
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">To make the discussions that follow more concrete,
we begin with a couple of examples showing how the
Plan 9 security architecture appears to the user.
These examples both involve a user
</span><span style="font-size: 10pt"><tt>gre</tt></span><span style="font-size: 10pt">
logging in after booting a local machine.
The user may or may not have a secure store in which
all his keys are kept.
If he does,
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
will prompt him for the password to the secure store
and obtain keys from it, prompting only when a key
isn&rsquo;t found in the store.
Otherwise,
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
must prompt for each key.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">In the typescripts, </span><span style="font-size: 10pt"><tt><i></i></tt></span><span style="font-size: 9pt"><tt><i>\n</i></tt></span><span style="font-size: 10pt"><tt><i></i></tt></span><span style="font-size: 10pt">
represents a literal newline
character typed to force a default response.
User input is in italics, and
long lines are folded and indented to fit.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">This first example shows a user logging in without
help from the secure store.
First,
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
prompts for a user name that the local kernel
will use:
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>user[none]: </tt></span><span style="font-size: 9pt"><tt><i></i></tt></span><span style="font-size: 9pt"><tt><i>gre</i></tt></span><span style="font-size: 9pt"><tt><i></i></tt></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">(Default responses appear in square brackets.)
The kernel then starts accessing local resources
and requests, through
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">,
a user/password pair to do so:
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>!Adding key: dom=cs.bell-labs.com</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    proto=p9sk1</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>user[gre]: </tt></span><span style="font-size: 9pt"><tt><i></i></tt></span><span style="font-size: 9pt"><tt><i>\n</i></tt></span><span style="font-size: 9pt"><tt><i></i></tt></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>password: </tt></span><span style="font-size: 9pt"><tt><i>****</i></tt></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Now the user is logged in to the local system, and
the mail client starts up:
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>!Adding key: proto=apop</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    server=plan9.bell-labs.com</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>user[gre]: </tt></span><span style="font-size: 9pt"><tt><i></i></tt></span><span style="font-size: 9pt"><tt><i>\n</i></tt></span><span style="font-size: 9pt"><tt><i></i></tt></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>password: </tt></span><span style="font-size: 9pt"><tt><i>****</i></tt></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"></span><span style="font-size: 10pt"><tt>Factotum</tt></span><span style="font-size: 10pt">
is doing all the prompting and the applications
being started are not even touching the keys.
Note that it&rsquo;s always clear which key is being requested.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Now consider the same login sequence, but in the case where
</span><span style="font-size: 10pt"><tt>gre</tt></span><span style="font-size: 10pt">
has a secure store account:
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>user[none]: </tt></span><span style="font-size: 9pt"><tt><i></i></tt></span><span style="font-size: 9pt"><tt><i>gre</i></tt></span><span style="font-size: 9pt"><tt><i></i></tt></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>secstore password: </tt></span><span style="font-size: 9pt"><tt><i>*********</i></tt></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>STA PIN+SecurID: </tt></span><span style="font-size: 9pt"><tt><i>*********</i></tt></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">That&rsquo;s the last
</span><span style="font-size: 10pt"><tt>gre</tt></span><span style="font-size: 10pt">
will hear from
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
unless an attempt is made to contact
a system for which no key is kept in the secure store.
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>2.2.
The factotum
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Each computer running Plan 9 has one user id that owns all the
resources on that system &mdash; the scheduler, local disks,
network interfaces, etc.
That user, the
</span><span style="font-size: 10pt"><i>host owner</i></span><span style="font-size: 10pt">,
is the closest analogue in Plan 9 to a Unix
</span><span style="font-size: 10pt"><tt>root</tt></span><span style="font-size: 10pt">
account (although it is far weaker;
rather than having special powers, as its name implies the host owner
is just a regular user that happens to own the
resources of the local machine).
On a single-user system, which we call a terminal,
the host owner is the id of the terminal&rsquo;s user.
Shared servers such as CPU servers normally have a pseudo-user
that initially owns all resources.
At boot time, the Plan 9 kernel starts a
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
executing as, and therefore with the privileges of,
the host owner.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">New processes run as
the same user as the process which created them.
When a process must take on the identity of a new user,
such as to provide a login shell
on a shared CPU server,
it does so by proving to the host owner&rsquo;s
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
that it is
authorized to do so.
This is done by running an
authentication protocol with
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
to
prove that the process has access to secret information
which only the new user should possess.
For example, consider the setup in Figure 1a.
If a user on the terminal
wants to log in to the CPU server using the
Plan 9
</span><span style="font-size: 10pt"><tt>cpu</tt></span><span style="font-size: 10pt">
service
[Pike93],
then
</span><span style="font-size: 10pt"></span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>P</i></span><span style="font-size: 11pt"><sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i>T</i></span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sub><span style="font-size: 11pt"></span><span style="font-size: 10pt">
might be the
</span><span style="font-size: 10pt"><tt>cpu</tt></span><span style="font-size: 10pt">
client program and
</span><span style="font-size: 10pt"></span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>P</i></span><span style="font-size: 11pt"><sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sub><span style="font-size: 11pt"></span><span style="font-size: 10pt">
the
</span><span style="font-size: 10pt"><tt>cpu</tt></span><span style="font-size: 10pt">
server.
</span><span style="font-size: 10pt">Neither </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>P</i></span><span style="font-size: 11pt"><sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sub><span style="font-size: 11pt"></span><span style="font-size: 10pt"> nor </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>P</i></span><span style="font-size: 11pt"><sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i>T</i></span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sub><span style="font-size: 11pt"></span><span style="font-size: 10pt">
knows the details of the authentication.
They
do need to be able to shuttle messages back and
forth between the two
</span><span style="font-size: 10pt"><tt>factotums</tt></span><span style="font-size: 10pt">,
but this is
a generic function easily performed without
knowing, or being able to extract, secrets in
the messages.
</span><span style="font-size: 10pt"></span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>P</i></span><span style="font-size: 11pt"><sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i>T</i></span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sub><span style="font-size: 11pt"></span><span style="font-size: 10pt">
</span><span style="font-size: 10pt">will make a network connection to </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>P</i></span><span style="font-size: 11pt"><sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sub><span style="font-size: 11pt"></span><span style="font-size: 10pt">.
</span><span style="font-size: 10pt"></span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>P</i></span><span style="font-size: 11pt"><sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i>T</i></span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sub><span style="font-size: 11pt"></span><span style="font-size: 10pt">
and
</span><span style="font-size: 10pt"></span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>P</i></span><span style="font-size: 11pt"><sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sub><span style="font-size: 11pt"></span><span style="font-size: 10pt">
will then relay messages between
the
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
</span><span style="font-size: 10pt">owned by the user, </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>F</i></span><span style="font-size: 11pt"><sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i>T</i></span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sub><span style="font-size: 11pt"></span><span style="font-size: 10pt">,
</span><span style="font-size: 10pt">and the one owned by the CPU server, </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>F</i></span><span style="font-size: 11pt"><sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sub><span style="font-size: 11pt"></span><span style="font-size: 10pt">,
until mutual authentication has been established.
Later
sections describe the RPC between
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
and
applications and the library functions to support proxy operations.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The kernel always uses a single local instance of
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">,
running as the
host owner, for
its authentication purposes, but
a regular user may start other
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
agents.
In fact, the
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
representing the user need not be
running on the same machine as its client.
For instance, it is easy for a user on a CPU server,
through standard Plan 9 operations,
to replace the
</span><span style="font-size: 10pt"><tt>/mnt/factotum</tt></span><span style="font-size: 10pt">
in the user&rsquo;s private file name space on the server
with a connection to the
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
running on the terminal.
(The usual file system permissions prevent interlopers
from doing so maliciously.)
This permits secure operations on the CPU server to be
transparently validated by the user&rsquo;s own
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">,
so
secrets need never leave the user&rsquo;s terminal.
The SSH agent
[Ylon96]
does much the
same with special SSH protocol messages, but
an advantage to making our agent a file system
is that we need no new mechanism to access our remote
agent; remote file access is sufficient.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Within
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">,
each protocol is implemented as a state
machine with a generic interface, so protocols are in
essence pluggable modules, easy to add, modify, or drop.
Writing a message to and reading a message from
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
each require a separate RPC and result in
a single state transition.
Therefore
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
always runs to completion on every RPC and never blocks
waiting for input during any authentication.
Moreover, the number of simultaneous
authentications is limited only by the amount of memory we&rsquo;re
willing to dedicate to representing the state machines.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Authentication protocols are implemented only
within
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">,
but adding and removing
protocols does require relinking the binary, so
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
processes (but no others)
need to be restarted in order to take advantage of
new or repaired protocols.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">At the time of writing, 
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
contains authentication
modules for the Plan 9 shared key protocol (p9sk1),
SSH&rsquo;s RSA authentication, passwords in the clear, APOP, CRAM, PPP&rsquo;s CHAP,
Microsoft PPP&rsquo;s MSCHAP, and VNC&rsquo;s challenge/response.
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>2.3.
Local capabilities
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">A capability system, managed by the kernel, is used to empower
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
to grant permission to another process to change its user id.
A
kernel device driver
implements two files,
</span><span style="font-size: 10pt"><tt>/dev/caphash</tt></span><span style="font-size: 10pt">
and
</span><span style="font-size: 10pt"><tt>/dev/capuse</tt></span><span style="font-size: 10pt">.
The write-only file
</span><span style="font-size: 10pt"><tt>/dev/caphash</tt></span><span style="font-size: 10pt">
can be opened only by the host owner, and only once.
</span><span style="font-size: 10pt"><tt>Factotum</tt></span><span style="font-size: 10pt">
opens this file immediately after booting.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">To use the files,
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
creates a string of the form
</span><span style="font-size: 10pt"><tt></tt></span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><tt></tt></span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><tt></tt></span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><tt></tt></span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>userid1</i></span><span style="font-size: 10pt"><tt>@</tt></span><span style="font-size: 10pt"><i>userid2</i></span><span style="font-size: 10pt"><tt>@</tt></span><span style="font-size: 10pt"><i>random-string</i></span><span style="font-size: 10pt">,
uses SHA1 HMAC to hash
</span><span style="font-size: 10pt"><tt></tt></span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><tt></tt></span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>userid1</i></span><span style="font-size: 10pt"><tt>@</tt></span><span style="font-size: 10pt"><i>userid2</i></span><span style="font-size: 10pt">
with key
</span><span style="font-size: 10pt"><i>random-string</i></span><span style="font-size: 10pt">,
and writes that hash to
</span><span style="font-size: 10pt"><tt>/dev/caphash</tt></span><span style="font-size: 10pt">.
</span><span style="font-size: 10pt"><tt>Factotum</tt></span><span style="font-size: 10pt">
then passes the original string to another
process on the same machine, running
as user
</span><span style="font-size: 10pt"><i>userid1</i></span><span style="font-size: 10pt">,
which
writes the string to
</span><span style="font-size: 10pt"><tt>/dev/capuse</tt></span><span style="font-size: 10pt">.
The kernel hashes the string and looks for
a matching hash in its list.
If it finds one,
the writing process&rsquo;s user id changes from
</span><span style="font-size: 10pt"><i>userid1</i></span><span style="font-size: 10pt">
to
</span><span style="font-size: 10pt"><i>userid2</i></span><span style="font-size: 10pt">.
Once used, or if a timeout expires,
the capability is discarded by the kernel.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The capabilities are local to the machine on which they are created.
Hence a
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
running on one machine cannot pass capabilities
to processes on another and expect them to work.
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>2.4.
Keys
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">We define the word
</span><span style="font-size: 10pt"><i>key</i></span><span style="font-size: 10pt">
to mean not only a secret, but also a description of the
context in which that secret is to be used: the protocol,
server, user, etc. to which it applies.
That is,
a key is a combination of secret and descriptive information
used to authenticate the identities of parties
transmitting or receiving information.
The set of keys used
in any authentication depends both on the protocol and on
parameters passed by the program requesting the authentication.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Taking a tip from SDSI
[RiLa],
which represents security information as textual S-expressions,
keys in Plan 9 are represented as plain UTF-8 text.
Text is easily
understood and manipulated by users.
By contrast,
a binary or other cryptic format
can actually reduce overall security.
Binary formats are difficult for users to examine and can only be
cracked by special tools, themselves poorly understood by most users.
For example, very few people know or understand what&rsquo;s inside
their X.509 certificates.
Most don&rsquo;t even know where in the system to
find them.
Therefore, they have no idea what they are trusting, and why, and
are powerless to change their trust relationships.
Textual, centrally stored and managed keys are easier to use and safer.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Plan 9 has historically represented databases as attribute/value pairs,
since they are a good foundation for selection and projection operations.
</span><span style="font-size: 10pt"><tt>Factotum</tt></span><span style="font-size: 10pt">
therefore represents
the keys in the format
</span><span style="font-size: 10pt"><tt></tt></span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><tt></tt></span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>attribute</i></span><span style="font-size: 10pt"><tt>=</tt></span><span style="font-size: 10pt"><i>value</i></span><span style="font-size: 10pt">,
where
</span><span style="font-size: 10pt"><i>attribute</i></span><span style="font-size: 10pt">
is an identifier, possibly with a single-character prefix, and
</span><span style="font-size: 10pt"><i>value</i></span><span style="font-size: 10pt">
is an arbitrary quoted string.
The pairs themselves are separated by white space.
For example, a Plan 9 key and an APOP key
might be represented like this:
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>dom=bell-labs.com proto=p9sk1 user=gre</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    !password=&rsquo;don&rsquo;&rsquo;t tell&rsquo;</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>proto=apop server=x.y.com user=gre</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    !password=&rsquo;open sesame&rsquo;</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">If a value is empty or contains white space or single quotes, it must be quoted;
quotes are represented by doubled single quotes.
Attributes that begin with an exclamation mark
(</span><span style="font-size: 10pt"><tt>!</tt></span><span style="font-size: 10pt">)
are considered
</span><span style="font-size: 10pt"><i>secret</i></span><span style="font-size: 10pt">.
</span><span style="font-size: 10pt"><tt>Factotum</tt></span><span style="font-size: 10pt">
will never let a secret value escape its address space
and will suppress keyboard echo when asking the user to type one.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">A program requesting authentication selects a key
by providing a
</span><span style="font-size: 10pt"><i>query</i></span><span style="font-size: 10pt">,
a list of elements to be matched by the key.
Each element in the list is either an
</span><span style="font-size: 10pt"><tt></tt></span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><tt></tt></span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>attribute</i></span><span style="font-size: 10pt"><tt>=</tt></span><span style="font-size: 10pt"><i>value</i></span><span style="font-size: 10pt">
pair, which is satisfied by keys with
exactly that pair;
or an attribute followed by a question mark,
</span><span style="font-size: 10pt"><tt></tt></span><span style="font-size: 10pt"><tt></tt></span><span style="font-size: 10pt"><i>attribute</i></span><span style="font-size: 10pt"><tt>?</tt></span><span style="font-size: 10pt">,
which is satisfied by keys with some pair specifying
the attribute.
A key matches a query if every element in the list
is satisfied.
For instance, to select the APOP key in the previous example,
an APOP client process might specify the query
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>server=x.y.com proto=apop</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Internally,
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">&rsquo;s
APOP module would add the requirements of
having
</span><span style="font-size: 10pt"><tt>user</tt></span><span style="font-size: 10pt">
and
</span><span style="font-size: 10pt"><tt>!password</tt></span><span style="font-size: 10pt">
attributes, forming the query
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>server=x.y.com proto=apop user? !password?</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">when searching for an appropriate key.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"></span><span style="font-size: 10pt"><tt>Factotum</tt></span><span style="font-size: 10pt">
modules expect keys to have some well-known attributes.
For instance, the
</span><span style="font-size: 10pt"><tt>proto</tt></span><span style="font-size: 10pt">
attribute specifies the protocol module
responsible for using a particular key,
and protocol modules may expect other well-known attributes
(many expect keys to have
</span><span style="font-size: 10pt"><tt>!password</tt></span><span style="font-size: 10pt">
attributes, for example).
Additional attributes can be used as comments or for
further discrimination without intervention by 
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">;
for example, the APOP and IMAP mail clients conventionally
include a
</span><span style="font-size: 10pt"><tt>server</tt></span><span style="font-size: 10pt">
attribute to select an appropriate key for authentication.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Unlike in SDSI,
keys in Plan 9 have no nested structure.  This design
keeps the representation simple and straightforward.
If necessary, we could add a nested attribute
or, in the manner of relational databases, an attribute that
selects another tuple, but so far the simple design has been sufficient.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">A simple common structure for all keys makes them easy for users
to administer,
but the set of attributes and their interpretation is still
protocol-specific and can be subtle.
Users may still
need to consult a manual to understand all details.
Many attributes
(</span><span style="font-size: 10pt"><tt>proto</tt></span><span style="font-size: 10pt">,
</span><span style="font-size: 10pt"><tt>user</tt></span><span style="font-size: 10pt">,
</span><span style="font-size: 10pt"><tt>password</tt></span><span style="font-size: 10pt">,
</span><span style="font-size: 10pt"><tt>server</tt></span><span style="font-size: 10pt">)
are self-explanatory and our short experience
has not uncovered any particular difficulty in handling keys.
Things
will likely get messier, however,
when we grapple with public
keys and their myriad components.
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>2.5.
Protecting keys
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Secrets must be prevented from escaping
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">.
There are a number of ways they could leak:
another process might be able to debug the agent process, the
agent might swap out to disk, or the process might willingly
disclose the key.
The last is the easiest to avoid:
secret information in a key is marked
as such, and
whenever
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
prints keys or queries for new
ones, it is careful to avoid displaying secret information.
(The only exception to this is the
&lsquo;&lsquo;plaintext password&rsquo;&rsquo; protocol, which consists
of sending the values of the
</span><span style="font-size: 10pt"><tt>user</tt></span><span style="font-size: 10pt">
and
</span><span style="font-size: 10pt"><tt>!password</tt></span><span style="font-size: 10pt">
attributes.
Only keys tagged with
</span><span style="font-size: 10pt"><tt>proto=pass</tt></span><span style="font-size: 10pt">
can have their passwords disclosed by this mechanism.)
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Preventing the first two forms of leakage
requires help from the kernel.
In Plan 9, every process is
represented by a directory in the
</span><span style="font-size: 10pt"><tt>/proc</tt></span><span style="font-size: 10pt">
file system.
Using the files in this directory,
other processes could (with appropriate access permission) examine
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">&rsquo;s
memory and registers.
</span><span style="font-size: 10pt"><tt>Factotum</tt></span><span style="font-size: 10pt">
is protected from processes of other users
by the default access bits of its
</span><span style="font-size: 10pt"><tt>/proc</tt></span><span style="font-size: 10pt">
directory.
However, we&rsquo;d also like to protect the
agent from other processes owned by the same user,
both to avoid honest mistakes and to prevent
an unattended terminal being
exploited to discover secret passwords.
To do this, we added a control message to
</span><span style="font-size: 10pt"><tt>/proc</tt></span><span style="font-size: 10pt">
called
</span><span style="font-size: 10pt"><tt>private</tt></span><span style="font-size: 10pt">.
Once the
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
process has written
</span><span style="font-size: 10pt"><tt>private</tt></span><span style="font-size: 10pt">
to its
</span><span style="font-size: 10pt"><tt>/proc/</tt></span><span style="font-size: 10pt"><i>pid</i></span><span style="font-size: 10pt"><tt>/ctl</tt></span><span style="font-size: 10pt">
file, no process can access
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">&rsquo;s
memory
through
</span><span style="font-size: 10pt"><tt>/proc</tt></span><span style="font-size: 10pt">.
(Plan 9 has no other mechanism, such as
</span><span style="font-size: 10pt"><tt>/dev/kmem</tt></span><span style="font-size: 10pt">,
for accessing a process&rsquo;s memory.)
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Similarly, the agent&rsquo;s address space should not be
swapped out, to prevent discovering unencrypted
keys on the swapping media.
The
</span><span style="font-size: 10pt"><tt>noswap</tt></span><span style="font-size: 10pt">
control message in
</span><span style="font-size: 10pt"><tt>/proc</tt></span><span style="font-size: 10pt">
prevents this scenario.
Neither
</span><span style="font-size: 10pt"><tt>private</tt></span><span style="font-size: 10pt">
nor
</span><span style="font-size: 10pt"><tt>noswap</tt></span><span style="font-size: 10pt">
is specific to
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">.
User-level file servers such as
</span><span style="font-size: 10pt"><tt>dossrv</tt></span><span style="font-size: 10pt">,
which interprets FAT file systems,
could use
</span><span style="font-size: 10pt"><tt>noswap</tt></span><span style="font-size: 10pt">
to keep their buffer caches from being
swapped to disk.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Despite our precautions, attackers might still
find a way to gain access to a process running as the host
owner on a machine.
Although they could not directly
access the keys, attackers could use the local
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
to perform authentications for them.
In the case
of some keys, for example those locking bank
accounts, we want a way to disable or at least
detect such access.
That is the role of the
</span><span style="font-size: 10pt"><tt>confirm</tt></span><span style="font-size: 10pt">
attribute in a key.
Whenever a key with a
</span><span style="font-size: 10pt"><tt>confirm</tt></span><span style="font-size: 10pt">
attribute is accessed, the local user must
confirm use of the key via a local GUI.
The next section describes the actual mechanism.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">We have not addressed leaks possible as a result of
someone rebooting or resetting a machine running
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">.
For example, someone could reset a machine
and reboot it with a debugger instead of a kernel,
allowing them to examine the contents of memory
and find keys.  We have not found a satisfactory
solution to this problem.
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>2.6.
Factotum transactions
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">External programs manage
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">&rsquo;s
internal key state
through its file interface,
writing textual
</span><span style="font-size: 10pt"><tt>key</tt></span><span style="font-size: 10pt">
and
</span><span style="font-size: 10pt"><tt>delkey</tt></span><span style="font-size: 10pt">
commands to the
</span><span style="font-size: 10pt"><tt>/mnt/factotum/ctl</tt></span><span style="font-size: 10pt">
file.
Both commands take a list of attributes as an argument.
</span><span style="font-size: 10pt"><tt>Key</tt></span><span style="font-size: 10pt">
creates a key with the given attributes, replacing any
extant key with an identical set of public attributes.
</span><span style="font-size: 10pt"><tt>Delkey</tt></span><span style="font-size: 10pt">
deletes all keys that match the given set of attributes.
Reading the 
</span><span style="font-size: 10pt"><tt>ctl</tt></span><span style="font-size: 10pt">
file returns a list of keys, one per line, displaying only public attributes.
The following example illustrates these interactions.
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>% cd /mnt/factotum</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>% ls -l</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>-lrw------- gre gre 0 Jan 30 22:17 confirm</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>--rw------- gre gre 0 Jan 30 22:17 ctl</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>-lr-------- gre gre 0 Jan 30 22:17 log</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>-lrw------- gre gre 0 Jan 30 22:17 needkey</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>--r--r--r-- gre gre 0 Jan 30 22:17 proto</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>--rw-rw-rw- gre gre 0 Jan 30 22:17 rpc</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>% cat &gt;ctl</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>key dom=bell-labs.com proto=p9sk1 user=gre</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    !password=&rsquo;don&rsquo;&rsquo;t tell&rsquo;</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>key proto=apop server=x.y.com user=gre</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    !password=&rsquo;bite me&rsquo;</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>^D</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>% cat ctl</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>key dom=bell-labs.com proto=p9sk1 user=gre</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>key proto=apop server=x.y.com user=gre</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>% echo &rsquo;delkey proto=apop&rsquo; &gt;ctl</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>% cat ctl</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>key dom=bell-labs.com proto=p9sk1 user=gre</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>% </tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">(A file with the
</span><span style="font-size: 10pt"><tt>l</tt></span><span style="font-size: 10pt">
bit set can be opened by only one process at a time.)
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The heart of the interface is the
</span><span style="font-size: 10pt"><tt>rpc</tt></span><span style="font-size: 10pt">
file.
Programs authenticate with
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
by writing a request to the
</span><span style="font-size: 10pt"><tt>rpc</tt></span><span style="font-size: 10pt">
file
and reading back the reply; this sequence is called an RPC
</span><span style="font-size: 10pt"><i>transaction</i></span><span style="font-size: 10pt">.
Requests and replies have the same format:
a textual verb possibly followed by arguments,
which may be textual or binary.
The most common reply verb is
</span><span style="font-size: 10pt"><tt>ok</tt></span><span style="font-size: 10pt">,
indicating success.
An RPC session begins with a
</span><span style="font-size: 10pt"><tt>start</tt></span><span style="font-size: 10pt">
transaction; the argument is a key query as described
earlier.
Once started, an RPC conversation usually consists of 
a sequence of
</span><span style="font-size: 10pt"><tt>read</tt></span><span style="font-size: 10pt">
and
</span><span style="font-size: 10pt"><tt>write</tt></span><span style="font-size: 10pt">
transactions.
If the conversation is successful, an
</span><span style="font-size: 10pt"><tt>authinfo</tt></span><span style="font-size: 10pt">
transaction will return information about
the identities learned during the transaction.
The
</span><span style="font-size: 10pt"><tt>attr</tt></span><span style="font-size: 10pt">
transaction returns a list of attributes for the current
conversation; the list includes any attributes given in
the 
</span><span style="font-size: 10pt"><tt>start</tt></span><span style="font-size: 10pt">
query as well as any public attributes from keys being used.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">As an example of the
</span><span style="font-size: 10pt"><tt>rpc</tt></span><span style="font-size: 10pt">
file in action, consider a mail client
connecting to a mail server and authenticating using
the POP3 protocol&rsquo;s APOP challenge-response command.
</span><span style="font-size: 10pt">There are four programs involved: the mail client </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>P</i></span><span style="font-size: 11pt"><sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sub><span style="font-size: 11pt"></span><span style="font-size: 10pt">, the client
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
</span><span style="font-size: 10pt"></span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>F</i></span><span style="font-size: 11pt"><sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sub><span style="font-size: 11pt"></span><span style="font-size: 10pt">, the mail server </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>P</i></span><span style="font-size: 11pt"><sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sub><span style="font-size: 11pt"></span><span style="font-size: 10pt">, and the server
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
</span><span style="font-size: 10pt"></span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>F</i></span><span style="font-size: 11pt"><sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sub><span style="font-size: 11pt"></span><span style="font-size: 10pt">.
All authentication computations are handled by the
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
processes.
The mail programs&rsquo; role is just to relay messages.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">At startup, the mail server at
</span><span style="font-size: 10pt"><tt>x.y.com</tt></span><span style="font-size: 10pt">
begins an APOP conversation
with its
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
to obtain the banner greeting, which
includes a challenge:
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>P</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>F</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt>: start proto=apop role=server</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>F</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>P</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt>: ok</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>P</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>F</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt>: read</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>F</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>P</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt>: ok +OK POP3 </tt></span><span style="font-size: 9pt"><i>challenge</i></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Having obtained the challenge, the server greets the client:
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>P</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>P</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt>: +OK POP3 </tt></span><span style="font-size: 9pt"><i>challenge</i></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The client then uses an APOP conversation with its
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
to obtain a response:
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>P</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>F</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt>: start proto=apop role=client</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>            server=x.y.com</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>F</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>P</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt>: ok</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>P</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>F</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt>: write +OK POP3 </tt></span><span style="font-size: 9pt"><i>challenge</i></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>F</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>P</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt>: ok</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>P</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>F</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt>: read</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>F</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>P</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt>: ok APOP gre </tt></span><span style="font-size: 9pt"><i>response</i></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"></span><span style="font-size: 10pt"><tt>Factotum</tt></span><span style="font-size: 10pt">
requires that
</span><span style="font-size: 10pt"><tt>start</tt></span><span style="font-size: 10pt">
requests include a 
</span><span style="font-size: 10pt"><tt>proto</tt></span><span style="font-size: 10pt">
attribute, and the APOP module requires an additional
</span><span style="font-size: 10pt"><tt>role</tt></span><span style="font-size: 10pt">
attribute, but the other attributes are optional and only
restrict the key space.
Before responding to the
</span><span style="font-size: 10pt"><tt>start</tt></span><span style="font-size: 10pt">
transaction, the client
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
looks for a key to
use for the rest of the conversation.
Because of the arguments in the
</span><span style="font-size: 10pt"><tt>start</tt></span><span style="font-size: 10pt">
request, the key must have public attributes
</span><span style="font-size: 10pt"><tt>proto=apop</tt></span><span style="font-size: 10pt">
and
</span><span style="font-size: 10pt"><tt>server=x.y.com</tt></span><span style="font-size: 10pt">;
as mentioned earlier,
the APOP module additionally requires that the key have
</span><span style="font-size: 10pt"><tt>user</tt></span><span style="font-size: 10pt">
and
</span><span style="font-size: 10pt"><tt>!password</tt></span><span style="font-size: 10pt">
attributes.
Now that the client has obtained a response
from its
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">,
it echoes that response to the server:
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>P</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>P</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt>: APOP gre </tt></span><span style="font-size: 9pt"><i>response</i></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Similarly, the server passes this message to
its
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
and obtains another to send back.
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>P</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>F</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt>: write APOP gre </tt></span><span style="font-size: 9pt"><i>response</i></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>F</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>P</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt>: ok</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>P</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>F</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt>: read</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>F</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>P</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt>: ok +OK welcome</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.15in"></p>

<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>P</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>P</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt>: +OK welcome</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Now the authentication protocol is done, and
the server can retrieve information
about what the protocol established.
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>P</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>F</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt>: authinfo</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>F</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>P</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt>: ok client=gre</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>            capability=</tt></span><span style="font-size: 9pt"><i>capability</i></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The
</span><span style="font-size: 10pt"><tt>authinfo</tt></span><span style="font-size: 10pt">
data is a list of
</span><span style="font-size: 10pt"><tt></tt></span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><tt></tt></span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>attr</i></span><span style="font-size: 10pt"><tt>=</tt></span><span style="font-size: 10pt"><i>value</i></span><span style="font-size: 10pt">
pairs, here a client user name and a capability.
(Protocols that establish shared secrets or provide
mutual authentication indicate this by adding
appropriate
</span><span style="font-size: 10pt"><tt></tt></span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><tt></tt></span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>attr</i></span><span style="font-size: 10pt"><tt>=</tt></span><span style="font-size: 10pt"><i>value</i></span><span style="font-size: 10pt">
pairs.)
The capability can be used by the server to change its
identity to that of the client, as described earlier.
Once it has changed its identity, the server can access and serve
the client&rsquo;s mailbox.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Two more files provide hooks for a graphical
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
control interface.
The first, 
</span><span style="font-size: 10pt"><tt>confirm</tt></span><span style="font-size: 10pt">,
allows the user detailed control over the use of certain keys.
If a key has a
</span><span style="font-size: 10pt"><tt>confirm=</tt></span><span style="font-size: 10pt">
attribute, then the user must approve each use of the key.
A separate program with a graphical interface reads from the
</span><span style="font-size: 10pt"><tt>confirm</tt></span><span style="font-size: 10pt">
file to see when a confirmation is necessary.
The read blocks until a key usage needs to be approved, whereupon
it will return a line of the form
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>confirm tag=1 </tt></span><span style="font-size: 9pt"><i>attributes</i></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">requesting permission to use the key with those public attributes.
The graphical interface then prompts the user for approval
and writes back
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>tag=1 answer=yes</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">(or
</span><span style="font-size: 10pt"><tt>answer=no</tt></span><span style="font-size: 10pt">).
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The second file,
</span><span style="font-size: 10pt"><tt>needkey</tt></span><span style="font-size: 10pt">,
diverts key requests.
In the APOP example, if a suitable key had not been found
during the
</span><span style="font-size: 10pt"><tt>start</tt></span><span style="font-size: 10pt">
transaction,
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
would have indicated failure by
returning a response indicating
what key was needed:
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>F</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>P</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt>: needkey proto=apop</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    server=x.y.com user? !password?</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">A typical client would then prompt the user for the desired
key information, create a new key via the
</span><span style="font-size: 10pt"><tt>ctl</tt></span><span style="font-size: 10pt">
file, and then reissue the 
</span><span style="font-size: 10pt"><tt>start</tt></span><span style="font-size: 10pt">
request.
If the
</span><span style="font-size: 10pt"><tt>needkey</tt></span><span style="font-size: 10pt">
file is open,
then instead of failing, the transaction
will block, and the next read from the
</span><span style="font-size: 10pt"><tt>/mnt/factotum/needkey</tt></span><span style="font-size: 10pt">
file will return a line of the form
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>needkey tag=1 </tt></span><span style="font-size: 9pt"><i>attributes</i></span><span style="font-size: 9pt"><i></i></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The graphical interface then prompts the user for the needed
key information, creates the key via the
</span><span style="font-size: 10pt"><tt>ctl</tt></span><span style="font-size: 10pt">
file, and writes back
</span><span style="font-size: 10pt"><tt>tag=1</tt></span><span style="font-size: 10pt">
to resume the transaction.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The remaining files are informational and used for debugging.
The
</span><span style="font-size: 10pt"><tt>proto</tt></span><span style="font-size: 10pt">
file contains a list of supported protocols (to see what protocols the
system supports,
</span><span style="font-size: 10pt"><tt>cat</tt></span><span style="font-size: 10pt">
</span><span style="font-size: 10pt"><tt>/mnt/factotum/proto</tt></span><span style="font-size: 10pt">),
and the
</span><span style="font-size: 10pt"><tt>log</tt></span><span style="font-size: 10pt">
file contains a log of operations and debugging output
enabled by a
</span><span style="font-size: 10pt"><tt>debug</tt></span><span style="font-size: 10pt">
control message.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The next few sections explain how
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
is used by system services.
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>3.
Authentication in 9P
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Plan 9 uses a remote file access protocol, 9P
[Pike93],
to connect to resources such as the
file server and remote processes.
The original design for 9P included special messages at the start of a conversation
to authenticate the user.
Multiple users can share a single connection, such as when a CPU server
runs processes for many users connected to a single file server,
but each must authenticate separately.
The authentication protocol, similar to that of Kerberos
[Stei88],
used a sequence of messages passed between client, file server, and authentication
server to verify the identities of the user, calling machine, and serving machine.
One major drawback to the design was that the authentication method was defined by 9P
itself and could not be changed.  
Moreover, there was no mechanism to relegate
authentication to an external (trusted) agent,
so a process implementing 9P needed, besides support for file service,
a substantial body of cryptographic code to implement a handful of startup messages
in the protocol.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">A recent redesign of 9P
addressed a number of file service issues outside the scope of this paper.
On issues of authentication, there were two goals:
first, to remove details about authentication from the
protocol itself; second, to allow an external program to execute the authentication
part of the protocol.
In particular, we wanted a way to quickly incorporate
ideas found in other systems such as SFS
[Mazi99].
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Since 9P is a file service protocol, the solution involved creating a new type of file
to be served: an
</span><span style="font-size: 10pt"><i>authentication</i></span><span style="font-size: 10pt">
</span><span style="font-size: 10pt"><i>file</i></span><span style="font-size: 10pt">.
Connections to a 9P service begin in a state that
allows no general file access but permits the client
to open an authentication file
by sending a special message, generated by the new
</span><span style="font-size: 10pt"><tt>fauth</tt></span><span style="font-size: 10pt">
system call:
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>afd = fauth(int fd, char *servicename);</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Here
</span><span style="font-size: 10pt"><tt>fd</tt></span><span style="font-size: 10pt">
is the user&rsquo;s file descriptor for the established network connection to the 9P server
and
</span><span style="font-size: 10pt"><tt>servicename</tt></span><span style="font-size: 10pt">
is the name of the desired service offered on that server, typically the file subsystem
to be accessed.
The returned file descriptor,
</span><span style="font-size: 10pt"><tt>afd</tt></span><span style="font-size: 10pt">,
is a unique handle representing the authentication file
created for this connection to authenticate to
this service; it is analogous to a capability.
The authentication file represented by
</span><span style="font-size: 10pt"><tt>afd</tt></span><span style="font-size: 10pt">
is not otherwise addressable on the server, such as through
the file name hierarchy.
In all other respects, it behaves like a regular file;
most important, it accepts standard read and write operations.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">To prove its identity, the user process (via
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">)
executes the authentication protocol,
described in the next section of this paper,
over the
</span><span style="font-size: 10pt"><tt>afd</tt></span><span style="font-size: 10pt">
file descriptor with ordinary reads and writes.
When client and server have successfully negotiated, the authentication file
changes state so it can be used as evidence of authority in
</span><span style="font-size: 10pt"><tt>mount</tt></span><span style="font-size: 10pt">.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Once identity is established, the process presents the (now verified)
</span><span style="font-size: 10pt"><tt>afd</tt></span><span style="font-size: 10pt">
as proof of identity to the
</span><span style="font-size: 10pt"><tt>mount</tt></span><span style="font-size: 10pt">
system call:
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>mount(int fd, int afd, char *mountpoint,</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>      int flag, char *servicename)</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">If the
</span><span style="font-size: 10pt"><tt>mount</tt></span><span style="font-size: 10pt">
succeeds, the user now
has appropriate permissions for the file hierarchy made
visible at the mount point.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">This sequence of events has several advantages.
First, the actual authentication protocol is implemented using regular reads and writes,
not special 9P messages, so
they can be processed, forwarded, proxied, and so on by
any 9P agent without special arrangement.
Second, the business of negotiating the authentication by reading and writing the
authentication file can be delegated to an outside agent, in particular
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">;
the programs that implement the client and server ends of a 9P conversation need
no authentication or cryptographic code.
Third,
since the authentication protocol is not defined by 9P itself, it is easy to change and
can even be negotiated dynamically.
Finally, since
</span><span style="font-size: 10pt"><tt>afd</tt></span><span style="font-size: 10pt">
acts like a capability, it can be treated like one:
handed to another process to give it special permissions;
kept around for later use when authentication is again required;
or closed to make sure no other process can use it.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">All these advantages stem from moving the authentication negotiation into
reads and writes on a separate file.
As is often the case in Plan 9,
making a resource (here authentication) accessible with a file-like interface
reduces
</span><span style="font-size: 10pt"><i>a</i></span><span style="font-size: 10pt">
</span><span style="font-size: 10pt"><i>priori</i></span><span style="font-size: 10pt">
the need for special interfaces.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>3.1.
Plan 9 shared key protocol
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">In addition to the various standard protocols supported by
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">,
we use a shared key protocol for native
Plan 9 authentication.
This protocol provides backward compatibility with
older versions of the system.  One reason for the new
architecture is to let us replace such protocols
in the near future with more cryptographically secure ones.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>P9sk1</i></span><span style="font-size: 10pt">
is a shared key protocol that uses tickets much like those
in the original Kerberos.
The difference is that we&rsquo;ve
replaced the expiration time in Kerberos tickets with
a random nonce parameter and a counter.
We summarize it here:
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>C</i></span><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>S</i></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">:</span><span style="font-size: 11pt"><tt>  </tt></span><span style="font-size: 11pt"><i>nonce</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>S</i></span><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>C</i></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">:</span><span style="font-size: 11pt"><tt>  </tt></span><span style="font-size: 11pt"><i>nonce</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>uid</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>domain</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.15in"></p>

<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>C</i></span><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>A</i></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">:</span><span style="font-size: 11pt"><tt>  </tt></span><span style="font-size: 11pt"><i>nonce</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>uid</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>domain</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>uid</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>         </tt></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>factotum</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>A</i></span><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>C</i></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">:</span><span style="font-size: 11pt"><tt>  </tt></span><span style="font-size: 11pt"><i>K</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">{</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>nonce</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>uid</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>uid</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt">,</span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>K</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>n</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">}</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>         </tt></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>K</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">{</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>nonce</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>uid</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>uid</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt">,</span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>K</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>n</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">}</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.15in"></p>

<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>C</i></span><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>S</i></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">:</span><span style="font-size: 11pt"><tt>  </tt></span><span style="font-size: 11pt"><i>K</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">{</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>nonce</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>uid</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>uid</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>K</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>n</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">}</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>         </tt></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>K</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>n</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">{</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>nonce</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>counter</i></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">}</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>S</i></span><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>C</i></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">:</span><span style="font-size: 11pt"><tt>  </tt></span><span style="font-size: 11pt"><i>K</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>n</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">{</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>nonce</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>counter</i></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">}</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">(Here </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>K</i></span><span style="font-size: 11pt"></span><span style="font-size: 11pt">{</span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>x</i></span><span style="font-size: 11pt"></span><span style="font-size: 11pt">}</span><span style="font-size: 11pt"></span><span style="font-size: 10pt"> indicates </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>x</i></span><span style="font-size: 11pt"></span><span style="font-size: 10pt"> encrypted with
</span><span style="font-size: 10pt">DES key </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>K</i></span><span style="font-size: 11pt"></span><span style="font-size: 10pt">.)
The first two messages exchange nonces and server identification.
After this initial exchange, the client contacts the authentication
server to obtain a pair of encrypted tickets, one encrypted with
the client key and one with the server key.
The client relays the server ticket to the server.
The server believes that the ticket is new
because it contains
</span><span style="font-size: 10pt"></span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>nonce</i></span><span style="font-size: 11pt"><sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sub><span style="font-size: 11pt"></span><span style="font-size: 10pt">
and that the ticket is from the authentication
</span><span style="font-size: 10pt">server because it is encrypted in the server key </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>K</i></span><span style="font-size: 11pt"><sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sub><span style="font-size: 11pt"></span><span style="font-size: 10pt">.
The ticket is basically a statement from the authentication
</span><span style="font-size: 10pt">server that now </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>uid</i></span><span style="font-size: 11pt"><sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sub><span style="font-size: 11pt"></span><span style="font-size: 10pt"> and </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>uid</i></span><span style="font-size: 11pt"><sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sub><span style="font-size: 11pt"></span><span style="font-size: 10pt"> share a
</span><span style="font-size: 10pt">secret </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>K</i></span><span style="font-size: 11pt"><sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i>n</i></span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sub><span style="font-size: 11pt"></span><span style="font-size: 10pt">.
</span><span style="font-size: 10pt">The authenticator </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>K</i></span><span style="font-size: 11pt"><sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i>n</i></span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sub><span style="font-size: 11pt"></span><span style="font-size: 11pt">{</span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>nonce</i></span><span style="font-size: 11pt"><sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sub><span style="font-size: 11pt"></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>counter</i></span><span style="font-size: 11pt"></span><span style="font-size: 11pt">}</span><span style="font-size: 11pt"></span><span style="font-size: 10pt">
</span><span style="font-size: 10pt">convinces the server that the client knows </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>K</i></span><span style="font-size: 11pt"><sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i>n</i></span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sub><span style="font-size: 11pt"></span><span style="font-size: 10pt"> and thus
</span><span style="font-size: 10pt">must be </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>uid</i></span><span style="font-size: 11pt"><sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sub><span style="font-size: 11pt"></span><span style="font-size: 10pt">.
</span><span style="font-size: 10pt">Similarly, authenticator </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>K</i></span><span style="font-size: 11pt"><sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i>n</i></span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sub><span style="font-size: 11pt"></span><span style="font-size: 11pt">{</span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>nonce</i></span><span style="font-size: 11pt"><sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sub><span style="font-size: 11pt"></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>counter</i></span><span style="font-size: 11pt"></span><span style="font-size: 11pt">}</span><span style="font-size: 11pt"></span><span style="font-size: 10pt">
</span><span style="font-size: 10pt">convinces the client that the server knows </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>K</i></span><span style="font-size: 11pt"><sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i>n</i></span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sub><span style="font-size: 11pt"></span><span style="font-size: 10pt"> and thus
</span><span style="font-size: 10pt">must be </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>uid</i></span><span style="font-size: 11pt"><sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sub><span style="font-size: 11pt"></span><span style="font-size: 10pt">.
Tickets can be reused, without contacting the authentication
server again, by incrementing the counter before each
authenticator is generated.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">In the future we hope to introduce a public key version of
p9sk1,
which would allow authentication even
when the authentication server is not available.
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>3.2.
The authentication server
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Each Plan 9 security domain has an authentication server (AS)
that all users trust to keep the complete set of shared keys.
It also offers services for users and administrators to manage the
keys, create and disable accounts, and so on.
It typically runs on
a standalone machine with few other services.
The AS comprises two services,
</span><span style="font-size: 10pt"><tt>keyfs</tt></span><span style="font-size: 10pt">
and
</span><span style="font-size: 10pt"><tt>authsrv</tt></span><span style="font-size: 10pt">.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"></span><span style="font-size: 10pt"><tt>Keyfs</tt></span><span style="font-size: 10pt">
is a user-level file system that manages an
encrypted database of user accounts.
Each account is represented by a directory containing the
files
</span><span style="font-size: 10pt"><tt>key</tt></span><span style="font-size: 10pt">,
containing the Plan 9 key for p9sk1;
</span><span style="font-size: 10pt"><tt>secret</tt></span><span style="font-size: 10pt">
for the challenge/response protocols (APOP, VNC, CHAP, MSCHAP,
CRAM);
</span><span style="font-size: 10pt"><tt>log</tt></span><span style="font-size: 10pt">
for authentication outcomes;
</span><span style="font-size: 10pt"><tt>expire</tt></span><span style="font-size: 10pt">
for an expiration time; and
</span><span style="font-size: 10pt"><tt>status</tt></span><span style="font-size: 10pt">.
If the expiration time passes,
if the number of successive failed authentications
exceeds 50, or if
</span><span style="font-size: 10pt"><tt>disabled</tt></span><span style="font-size: 10pt">
is written to the status file,
any attempt to access the
</span><span style="font-size: 10pt"><tt>key</tt></span><span style="font-size: 10pt">
or
</span><span style="font-size: 10pt"><tt>secret</tt></span><span style="font-size: 10pt">
files will fail.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"></span><span style="font-size: 10pt"><tt>Authsrv</tt></span><span style="font-size: 10pt">
is a network service that brokers shared key authentications
for the protocols p9sk1, APOP, VNC, CHAP, MSCHAP,
and CRAM.  Remote users can also call
</span><span style="font-size: 10pt"><tt>authsrv</tt></span><span style="font-size: 10pt">
to change their passwords.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The
p9sk1
protocol was described in the previous
section.
The challenge/response protocols differ
in detail but all follow the general structure:
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>C</i></span><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>S</i></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">:</span><span style="font-size: 11pt"><tt>  </tt></span><span style="font-size: 11pt"><i>nonce</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>S</i></span><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>C</i></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">:</span><span style="font-size: 11pt"><tt>  </tt></span><span style="font-size: 11pt"><i>nonce</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>uid</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>domain</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>C</i></span><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>A</i></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">:</span><span style="font-size: 11pt"><tt>  </tt></span><span style="font-size: 11pt"><i>nonce</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>uid</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>domain</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>         </tt></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>hostid</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>uid</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>A</i></span><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>C</i></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">:</span><span style="font-size: 11pt"><tt>  </tt></span><span style="font-size: 11pt"><i>K</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">{</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>nonce</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>uid</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>uid</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt">,</span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>K</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>n</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">}</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>         </tt></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>K</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">{</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>nonce</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>uid</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>uid</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt">,</span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>K</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>n</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">}</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>C</i></span><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>S</i></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">:</span><span style="font-size: 11pt"><tt>  </tt></span><span style="font-size: 11pt"><i>K</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">{</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>nonce</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>uid</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>uid</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt">,</span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>K</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>n</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">}</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>         </tt></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>K</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>n</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">{</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>nonce</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>S</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">}</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>S</i></span><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>C</i></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">:</span><span style="font-size: 11pt"><tt>  </tt></span><span style="font-size: 11pt"><i>K</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>n</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">{</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>nonce</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">}</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The password protocol is:
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>C</i></span><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>A</i></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">:</span><span style="font-size: 11pt"><tt>  </tt></span><span style="font-size: 11pt"><i>uid</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>C</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>A</i></span><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>C</i></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">:</span><span style="font-size: 11pt"><tt>  </tt></span><span style="font-size: 11pt"><i>K</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>c</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">{</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>K</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>n</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">}</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>C</i></span><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>A</i></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">:</span><span style="font-size: 11pt"><tt>  </tt></span><span style="font-size: 11pt"><i>K</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>n</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">{</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>password</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>old</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>password</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>new</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">}</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>A</i></span><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>C</i></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">:</span><span style="font-size: 11pt"><tt>  </tt></span><span style="font-size: 11pt"><i>OK</i></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">To avoid replay attacks, the pre-encryption
clear text for each of the protocols (as well as for p9sk1) includes
a tag indicating the encryption&rsquo;s role in the
protocol.  We elided them in these outlines.
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>3.3.
Protocol negotiation
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Rather than require particular protocols for particular services,
we implemented a negotiation metaprotocol,
</span><span style="font-size: 10pt"><i>p9any</i></span><span style="font-size: 10pt">,
which chooses the actual authentication protocol to use.
P9any
is used now by all native services on Plan 9.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The metaprotocol is simple.  The callee sends a
null-terminated string of the form:
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>v.</tt></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>n</i></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt> </tt></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>proto</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt">1</span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt>@</tt></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>domain</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt">1</span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt> </tt></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>proto</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt">2</span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt>@</tt></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>domain</i></span><span style="font-size: 11pt"><tt><sub></sub></tt><sub></sub></span><sub><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt">2</span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sub><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt> ...</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">where
</span><span style="font-size: 10pt"><i>n</i></span><span style="font-size: 10pt">
</span><span style="font-size: 10pt">is a decimal version number, </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>proto</i></span><span style="font-size: 11pt"><sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i>k</i></span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sub><span style="font-size: 11pt"></span><span style="font-size: 10pt">
is the name of a protocol for which the
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
</span><span style="font-size: 10pt">has a key, and </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>domain</i></span><span style="font-size: 11pt"><sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i>k</i></span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sub><span style="font-size: 11pt"></span><span style="font-size: 10pt">
is the name of the domain in which the key is
valid.
The caller then responds
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><i>proto</i></span><span style="font-size: 9pt"><tt>@</tt></span><span style="font-size: 9pt"><i>domain</i></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">indicating its choice.
Finally the callee responds
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>OK</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Any other string indicates failure.
At this point the chosen protocol commences.
The final fixed-length reply is used to make it easy to
delimit the I/O stream should the chosen protocol
require the caller rather than the callee to send the first message.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">With this negotiation metaprotocol, the underlying
authentication protocols used for Plan 9 services
can be changed under any application just
by changing the keys known by the
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
agents at each end.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">P9any is vulnerable to man in the middle attacks
to the extent that the attacker may constrain the
possible choices by changing the stream.  However,
we believe this is acceptable since the attacker
cannot force either side to choose algorithms
that it is unwilling to use.
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>4.
Library Interface to Factotum
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Although programs can access
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">&rsquo;s
services through its file system interface,
it is more common to use a C library that
packages the interaction.
There are a number of routines in the library,
not all of which are relevant here, but a few
examples should give their flavor.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">First, consider the problem of mounting a remote file server using 9P.
An earlier discussion showed how the
</span><span style="font-size: 10pt"><tt>fauth</tt></span><span style="font-size: 10pt">
and
</span><span style="font-size: 10pt"><tt>mount</tt></span><span style="font-size: 10pt">
system calls use an authentication file,
</span><span style="font-size: 10pt"><tt>afd</tt></span><span style="font-size: 10pt">,
as a capability,
but not how
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
manages
</span><span style="font-size: 10pt"><tt>afd</tt></span><span style="font-size: 10pt">.
The library contains a routine,
</span><span style="font-size: 10pt"><tt>amount</tt></span><span style="font-size: 10pt">
(authenticated mount), that is used by most programs in preference to
the raw
</span><span style="font-size: 10pt"><tt>fauth</tt></span><span style="font-size: 10pt">
and
</span><span style="font-size: 10pt"><tt>mount</tt></span><span style="font-size: 10pt">
calls.
</span><span style="font-size: 10pt"><tt>Amount</tt></span><span style="font-size: 10pt">
engages
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
to validate
</span><span style="font-size: 10pt"><tt>afd</tt></span><span style="font-size: 10pt">;
here is the complete code:
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>int</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>amount(int fd, char *mntpt,</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    int flags, char *aname)</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>{</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    int afd, ret;</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    AuthInfo *ai;</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.15in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    afd = fauth(fd, aname);</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    if(afd &gt;= 0){</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        ai = auth_proxy(afd, amount_getkey,</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>            "proto=p9any role=client");</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        if(ai != NULL)</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>            auth_freeAI(ai);</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    }</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    ret = mount(fd, afd, mntpt,</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        flags, aname);</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    if(afd &gt;= 0)</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        close(afd);</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    return ret;</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>}</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">where parameter
</span><span style="font-size: 10pt"><tt>fd</tt></span><span style="font-size: 10pt">
is a file descriptor returned by
</span><span style="font-size: 10pt"><tt>open</tt></span><span style="font-size: 10pt">
or
</span><span style="font-size: 10pt"><tt>dial</tt></span><span style="font-size: 10pt">
for a new connection to a file server.
The conversation with
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
occurs in the call to
</span><span style="font-size: 10pt"><tt>auth_proxy</tt></span><span style="font-size: 10pt">,
which specifies, as a key query,
which authentication protocol to use
(here the metaprotocol
</span><span style="font-size: 10pt"><tt>p9any</tt></span><span style="font-size: 10pt">)
and the role being played
(</span><span style="font-size: 10pt"><tt>client</tt></span><span style="font-size: 10pt">).
</span><span style="font-size: 10pt"><tt>Auth_proxy</tt></span><span style="font-size: 10pt">
will read and write the
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
files, and the authentication file descriptor
</span><span style="font-size: 10pt"><tt>afd</tt></span><span style="font-size: 10pt">,
to validate the user&rsquo;s right to access the service.
If the call is successful, any auxiliary data, held in an
</span><span style="font-size: 10pt"><tt>AuthInfo</tt></span><span style="font-size: 10pt">
structure, is freed.
In any case, the
</span><span style="font-size: 10pt"><tt>mount</tt></span><span style="font-size: 10pt">
is then called with the (perhaps validated)
</span><span style="font-size: 10pt"><tt>afd.</tt></span><span style="font-size: 10pt">
A 9P server can cause the
</span><span style="font-size: 10pt"><tt>fauth</tt></span><span style="font-size: 10pt">
system call to fail, as an indication that authentication is
not required to access the service.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The second argument to
</span><span style="font-size: 10pt"><tt>auth_proxy</tt></span><span style="font-size: 10pt">
is a function, here
</span><span style="font-size: 10pt"><tt>amount_getkey</tt></span><span style="font-size: 10pt">,
to be called if secret information such as a password or
response to a challenge is required as part of the authentication.
This function, of course, will provide this data to
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
as a
</span><span style="font-size: 10pt"><tt>key</tt></span><span style="font-size: 10pt">
message on the
</span><span style="font-size: 10pt"><tt>/mnt/factotum/ctl</tt></span><span style="font-size: 10pt">
file.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Although the final argument to
</span><span style="font-size: 10pt"><tt>auth_proxy</tt></span><span style="font-size: 10pt">
in this example is a simple string, in general
it can be a formatted-print specifier in the manner of
</span><span style="font-size: 10pt"><tt>printf</tt></span><span style="font-size: 10pt">,
to enable the construction of more elaborate key queries.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">As another example, consider the Plan 9
</span><span style="font-size: 10pt"><tt>cpu</tt></span><span style="font-size: 10pt">
service, which exports local devices to a shell process on
a remote machine, typically
to connect the local screen and keyboard to a more powerful computer.
At heart,
</span><span style="font-size: 10pt"><tt>cpu</tt></span><span style="font-size: 10pt">
is a superset of a service called
</span><span style="font-size: 10pt"><tt>exportfs</tt></span><span style="font-size: 10pt">
[Pike93],
which allows one machine to see an arbitrary portion of the file name space
of another machine, such as to
export the network device to another machine
for gatewaying.
However,
</span><span style="font-size: 10pt"><tt>cpu</tt></span><span style="font-size: 10pt">
is not just
</span><span style="font-size: 10pt"><tt>exportfs</tt></span><span style="font-size: 10pt">
because it also delivers signals such as interrupt
and negotiates the initial environment
for the remote shell.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">To authenticate an instance of
</span><span style="font-size: 10pt"><tt>cpu</tt></span><span style="font-size: 10pt">
requires
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
processes on both ends: the local, client
end running as the user on a terminal
and the remote, server
end running as the host owner of the server machine.
Here is schematic code for the two ends:
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>/* client */</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>int</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>p9auth(int fd)</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>{</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    AuthInfo *ai;</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.15in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    ai = auth_proxy(fd, auth_getkey,</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        "proto=p9any role=client");</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    if(ai == NULL)</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        return -1;</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.15in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    /* start cpu protocol here */</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>}</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.15in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>/* server */</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>int</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>srvp9auth(int fd, char *user)</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>{</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    AuthInfo *ai;</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.15in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    ai = auth_proxy(fd, NULL,</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        "proto=p9any role=server");</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    if(ai == NULL)</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        return -1;</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    /* set user id for server process */</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    if(auth_chuid(ai, NULL) &lt; 0)</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        return -1;</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.15in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    /* start cpu protocol here */</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>}</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"></span><span style="font-size: 10pt"><tt>Auth_chuid</tt></span><span style="font-size: 10pt">
encapsulates the negotiation to change a user id using the
</span><span style="font-size: 10pt"><tt>caphash</tt></span><span style="font-size: 10pt">
and
</span><span style="font-size: 10pt"><tt>capuse</tt></span><span style="font-size: 10pt">
files of the (server) kernel.
Note that although the client process may ask the user for new keys, using
</span><span style="font-size: 10pt"><tt>auth_getkey</tt></span><span style="font-size: 10pt">,
the server machine, presumably a shared machine with a pseudo-user for
the host owner, sets the key-getting function to
</span><span style="font-size: 10pt"><tt>NULL</tt></span><span style="font-size: 10pt">.
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>5.
Secure Store
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"></span><span style="font-size: 10pt"><tt>Factotum</tt></span><span style="font-size: 10pt">
keeps its keys in volatile memory, which must somehow be
initialized at boot time.
Therefore,
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
must be
supplemented by a persistent store, perhaps
a floppy disk containing a key file of commands to be copied into
</span><span style="font-size: 10pt"><tt>/mnt/factotum/ctl</tt></span><span style="font-size: 10pt">
during bootstrap.
But removable media are a nuisance to carry and
are vulnerable to theft.
Keys could be stored encrypted on a shared file system, but
only if those keys are not necessary for authenticating to
the file system in the first place.
Even if the keys are encrypted under a user
password, a thief might well succeed with a dictionary attack.
Other risks of local storage are loss of the contents
through mechanical mishap or dead batteries.
Thus for convenience and
safety we provide a
</span><span style="font-size: 10pt"><tt>secstore</tt></span><span style="font-size: 10pt">
(secure store) server in the network to hold each user&rsquo;s permanent list of keys, a
</span><span style="font-size: 10pt"><i>key</i></span><span style="font-size: 10pt">
</span><span style="font-size: 10pt"><i>file</i></span><span style="font-size: 10pt">.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"></span><span style="font-size: 10pt"><tt>Secstore</tt></span><span style="font-size: 10pt">
is a file server for encrypted data,
used only during bootstrapping.
It must provide strong
authentication and resistance to passive and active protocol attacks
while assuming nothing more from the client than a password.
Once
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
has loaded the key file, further encrypted or authenticated
file storage can be accomplished by standard mechanisms.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The cryptographic technology that enables
</span><span style="font-size: 10pt"><tt>secstore</tt></span><span style="font-size: 10pt">
is a form of encrypted
key exchange
called PAK
[Boyk00],
analogous to
EKE
[Bell93],
SRP
[Wu98],
or
SPEKE
[Jabl].
PAK was chosen
because it comes with a proof of equivalence in strength to
Diffie-Hellman; subtle flaws in some earlier encrypted key exchange
protocols and implementations have encouraged us to take special care.
In outline, the PAK protocol is:
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>C</i></span><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>S</i></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">:</span><span style="font-size: 11pt"><tt> </tt></span><span style="font-size: 11pt"><i>C</i></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>g</i></span><span style="font-size: 11pt"><tt><sup></sup></tt><sup></sup></span><sup><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>x</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sup><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>H</i></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>S</i></span><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>C</i></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">:</span><span style="font-size: 11pt"><tt> </tt></span><span style="font-size: 11pt"><i>S</i></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>g</i></span><span style="font-size: 11pt"><tt><sup></sup></tt><sup></sup></span><sup><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>y</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sup><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>hash</i></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">(</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>g</i></span><span style="font-size: 11pt"><tt><sup></sup></tt><sup></sup></span><sup><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>xy</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sup><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>C</i></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>S</i></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">)</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 11pt"><i>C</i></span><span style="font-size: 11pt"><tt>&rarr;</tt></span><span style="font-size: 11pt"><i>S</i></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">:</span><span style="font-size: 11pt"><tt> </tt></span><span style="font-size: 11pt"><i>hash</i></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">(</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>g</i></span><span style="font-size: 11pt"><tt><sup></sup></tt><sup></sup></span><sup><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 8pt"><i>xy</i></span><span style="font-size: 8pt"><tt></tt></span><span style="font-size: 11pt"><tt></tt></span></sup><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>S</i></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt"><i>C</i></span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 11pt">)</span><span style="font-size: 11pt"><tt></tt></span><span style="font-size: 9pt"><tt></tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">where </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>H</i></span><span style="font-size: 11pt"></span><span style="font-size: 10pt"> is a preshared secret between client </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>C</i></span><span style="font-size: 11pt"></span><span style="font-size: 10pt"> and server </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>S</i></span><span style="font-size: 11pt"></span><span style="font-size: 10pt">.
There are several variants of PAK, all presented in papers
mainly concerned with proofs of cryptographic properties.
To aid implementers, we have distilled a description of the specific
version we use into an Appendix to this paper.
The Plan 9 open source license provides for use of Lucent&rsquo;s
encrypted key exchange patents in this context.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">As a further layer of defense against password theft,
</span><span style="font-size: 10pt">we provide (within the encrypted channel </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>C</i></span><span style="font-size: 11pt">&rarr;</span><span style="font-size: 11pt"><i>S</i></span><span style="font-size: 11pt"></span><span style="font-size: 10pt">)
information that is validated at a RADIUS server,
such as the digits from a hardware token
[RFC2138].
This provides two-factor authentication, which potentially
requires tricking two independent administrators in any attack by
social engineering.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The key file stored on the server is encrypted with AES (Rijndael) using CBC
with a 10-byte initialization vector and trailing authentication padding.
All this is invisible to the user of
</span><span style="font-size: 10pt"><tt>secstore</tt></span><span style="font-size: 10pt">.
For that matter, it is invisible to the
</span><span style="font-size: 10pt"><tt>secstore</tt></span><span style="font-size: 10pt">
server as well;
if the AES Modes of Operation are standardized and a new encryption format
designed, it can be implemented by a client without change to the server.
The
</span><span style="font-size: 10pt"><tt>secstore</tt></span><span style="font-size: 10pt">
is deliberately not backed up;  the user is expected to
use more than one
</span><span style="font-size: 10pt"><tt>secstore</tt></span><span style="font-size: 10pt">
or save the key file on removable media
and lock it away.
</span><span style="font-size: 10pt">The user&rsquo;s password is hashed to create the </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>H</i></span><span style="font-size: 11pt"></span><span style="font-size: 10pt"> used
in the PAK protocol;  a different hash of the password is used as
the file encryption key.
Finally, there is a command (inside the authenticated,
encrypted channel between client and
</span><span style="font-size: 10pt"><tt>secstore</tt></span><span style="font-size: 10pt">)
to change passwords by sending
</span><span style="font-size: 10pt">a new </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>H</i></span><span style="font-size: 11pt"></span><span style="font-size: 10pt">; 
for consistency, the client process must at the same time fetch and re-encrypt all files.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">When
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
starts, it dials the local
</span><span style="font-size: 10pt"><tt>secstore</tt></span><span style="font-size: 10pt">
and checks whether the user has an account.
If so,
it prompts for the user&rsquo;s
</span><span style="font-size: 10pt"><tt>secstore</tt></span><span style="font-size: 10pt">
password and fetches the key file.
The PAK protocol
ensures mutual authentication and prevents dictionary attacks on the password
by passive wiretappers or active intermediaries.
Passwords saved in
the key file can be long random strings suitable for
simpler challenge/response authentication protocols.
Thus the user need only remember
a single, weaker password to enable strong, &lsquo;&lsquo;single sign on&rsquo;&rsquo; authentication to
unchanged legacy applications scattered across multiple authentication domains.
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>6.
Transport Layer Security
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Since the Plan 9 operating system is designed for use in network elements
that must withstand direct attack, unguarded by firewall or VPN, we seek
to ensure that all applications use channels with appropriate mutual
authentication and encryption.
A principal tool for this is TLS 1.0
[RFC2246].
(TLS 1.0 is nearly the same as SSL 3.0,
and our software is designed to interoperate
with implementations of either standard.)
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">TLS defines a record layer protocol for message integrity and privacy
through the use of message digesting and encryption with shared secrets.
We implement this service as a kernel device, though it could
be performed at slightly higher cost by invoking a separate program.
The library interface to the TLS kernel device is:
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>int pushtls(int fd, char *hashalg,</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    char *cryptalg, int isclient,</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    char *secret, char *dir);</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Given a file descriptor, the names of message digest and
encryption algorithms, and the shared secret,
</span><span style="font-size: 10pt"><tt>pushtls</tt></span><span style="font-size: 10pt">
returns a new file descriptor for the encrypted connection.
(The final argument
</span><span style="font-size: 10pt"><tt>dir</tt></span><span style="font-size: 10pt">
receives the name of the directory in the TLS device that
is associated with the new connection.)
The function is named by analogy with the &lsquo;&lsquo;push&rsquo;&rsquo; operation
supported by the stream I/O system of Research Unix and the
first two editions of Plan 9.
Because adding encryption is as simple as replacing one
file descriptor with another, adding encryption to a particular
network service is usually trivial.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The Plan 9 shared key authentication protocols establish a shared 56-bit secret
as a side effect.
Native Plan 9 network services such as
</span><span style="font-size: 10pt"><tt>cpu</tt></span><span style="font-size: 10pt">
and
</span><span style="font-size: 10pt"><tt>exportfs</tt></span><span style="font-size: 10pt">
use these protocols for authentication and then invoke 
</span><span style="font-size: 10pt"><tt>pushtls</tt></span><span style="font-size: 10pt">
with the shared secret.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Above the record layer, TLS specifies a handshake protocol using public keys
to establish the session secret.
This protocol is widely used with HTTP and IMAP4
to provide server authentication, though with client certificates it could provide
mutual authentication.  The library function
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>int tlsClient(int fd, TLSconn *conn)</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">handles the initial handshake and returns the result of
</span><span style="font-size: 10pt"><tt>pushtls</tt></span><span style="font-size: 10pt">.
On return, it fills the
</span><span style="font-size: 10pt"><tt>conn</tt></span><span style="font-size: 10pt">
structure with the session ID used
and the X.509 certificate presented by the
server, but makes no effort to verify the certificate.
Although the original design intent of X.509 certificates expected
that they would be used with a Public Key Infrastructure,
reliable deployment has been so long delayed and problematic
that we have adopted the simpler policy of just using the
X.509 certificate as a representation of the public key,
depending on a locally-administered directory of SHA1 thumbprints
to allow applications to decide which public keys to trust
for which purposes.
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>7.
Related Work and Discussion
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Kerberos, one of the earliest distributed authentication
systems, keeps a set of authentication tickets in a temporary file called
a ticket cache.  The ticket cache is protected by Unix file permissions.
An environment variable containing the file name of the ticket cache
allows for different ticket caches in different simultaneous login sessions.
A user logs in by typing his or her Kerberos password.
The login program uses the Kerberos password to obtain a temporary
ticket-granting ticket from the authentication server, initializes the
ticket cache with the ticket-granting ticket, and then forgets the password.
Other applications can use the ticket-granting ticket to sign tickets
for themselves on behalf of the user during the login session.
The ticket cache is removed when the user logs out
[Stei88].
The ticket cache relieves the user from typing a password
every time authentication is needed.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The secure shell SSH develops this idea further, replacing the
temporary file with a named Unix domain socket connected to
a user-level program, called an agent.
Once the SSH agent is started and initialized with one or
more RSA private keys, SSH clients can employ it
to perform RSA authentications on their behalf.
In the absence of an agent, SSH typically uses RSA keys
read from encrypted disk files or uses passphrase-based
authentication, both of which would require prompting the user
for a passphrase whenever authentication is needed
[Ylon96].
The self-certifying file system SFS uses a similar agent
[Kami00],
not only for moderating the use of client authentication keys 
but also for verifying server public keys
[Mazi99].
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"></span><span style="font-size: 10pt"><tt>Factotum</tt></span><span style="font-size: 10pt">
is a logical continuation of this evolution,
replacing the program-specific SSH or SFS agents with
a general agent capable of serving a wide variety of programs.
Having one agent for all programs removes the need
to have one agent for each program.
It also allows the programs themselves to be protocol-agnostic,
so that, for example, one could build an SSH workalike
capable of using any protocol supported by
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">,
without that program knowing anything about the protocols.
Traditionally each program needs to implement each
</span><span style="font-size: 10pt">authentication protocol for itself, an </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>O</i></span><span style="font-size: 11pt"></span><span style="font-size: 11pt">(</span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>n</i></span><span style="font-size: 11pt"><sup></sup></span><sup><span style="font-size: 8pt"></span><span style="font-size: 8pt">2</span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sup><span style="font-size: 11pt"></span><span style="font-size: 11pt">)</span><span style="font-size: 11pt"></span><span style="font-size: 10pt"> coding
problem that
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
</span><span style="font-size: 10pt">reduces to </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>O</i></span><span style="font-size: 11pt"></span><span style="font-size: 11pt">(</span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>n</i></span><span style="font-size: 11pt"></span><span style="font-size: 11pt">)</span><span style="font-size: 11pt"></span><span style="font-size: 10pt">.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Previous work on agents has concentrated on their use by clients
authenticating to servers.
Looking in the other direction, Sun Microsystem&rsquo;s 
pluggable authentication module (PAM) is one
of the earliest attempts to 
provide a general authentication mechanism for Unix-like 
operating systems
[Sama96].
Without a central authority like PAM, system policy is tied
up in the various implementations of network services.
For example, on a typical Unix, if a system administrator
decides not to allow plaintext passwords for authentication,
the configuration files for a half dozen different servers &mdash;
</span><span style="font-size: 10pt"><tt>rlogind</tt></span><span style="font-size: 10pt">,
</span><span style="font-size: 10pt"><tt>telnetd</tt></span><span style="font-size: 10pt">,
</span><span style="font-size: 10pt"><tt>ftpd</tt></span><span style="font-size: 10pt">,
</span><span style="font-size: 10pt"><tt>sshd</tt></span><span style="font-size: 10pt">,
and so on &mdash;
need to be edited.
PAM solves this problem by hiding the details of a given
authentication mechanism behind a common library interface.
Directed by a system-wide configuration file,
an application selects a particular authentication mechanism
by dynamically loading the appropriate shared library.
PAM is widely used on Sun&rsquo;s Solaris and some Linux distributions.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"></span><span style="font-size: 10pt"><tt>Factotum</tt></span><span style="font-size: 10pt">
achieves the same goals
using the agent approach.
</span><span style="font-size: 10pt"><tt>Factotum</tt></span><span style="font-size: 10pt">
is the only process that needs to create
capabilities, so all the network servers can run as 
untrusted users (e.g.,
Plan 9&rsquo;s
</span><span style="font-size: 10pt"><tt>none</tt></span><span style="font-size: 10pt">
or Unix&rsquo;s
</span><span style="font-size: 10pt"><tt>nobody</tt></span><span style="font-size: 10pt">),
which greatly reduces the harm done if a server is buggy
and is compromised.
In fact, if
</span><span style="font-size: 10pt"><tt>factotum</tt></span><span style="font-size: 10pt">
were implemented on Unix along with
an analogue to the Plan 9 capability device, venerable
programs like
</span><span style="font-size: 10pt"><tt>su</tt></span><span style="font-size: 10pt">
and
</span><span style="font-size: 10pt"><tt>login</tt></span><span style="font-size: 10pt">
would no longer need to be installed &lsquo;&lsquo;setuid root.&rsquo;&rsquo;
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Several other systems, such as Password Safe [Schn],
store multiple passwords in an encrypted file,
so that the user only needs to remember one password.
Our
</span><span style="font-size: 10pt"><tt>secstore</tt></span><span style="font-size: 10pt">
solution differs from these by placing the storage in
a hardened location in the network, so that the encrypted file is
less liable to be stolen for offline dictionary attack and so that
it is available even when a user has several computers.
In contrast, Microsoft&rsquo;s Passport system
[Micr]
keeps credentials in
the network, but centralized at one extremely-high-value target.
The important feature of Passport, setting up trust relationships
with e-merchants, is outside our scope.
The
</span><span style="font-size: 10pt"><tt>secstore</tt></span><span style="font-size: 10pt">
architecture is almost identical to
Perlman and Kaufman&rsquo;s
[Perl99]
but with newer EKE technology.
Like them, we chose to defend mainly against outside attacks
on
</span><span style="font-size: 10pt"><tt>secstore</tt></span><span style="font-size: 10pt">;
if additional defense of the files on the server
itself is desired, one can use distributed techniques
[Ford00].
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">We made a conscious choice of placing encryption, message integrity,
and key management at the application layer
(TLS, just above layer 4) rather than at layer 3, as in IPsec.
This leads to a simpler structure for the network stack, easier
integration with applications and, most important, easier network
administration since we can recognize which applications are misbehaving
based on TCP port numbers.  TLS does suffer (relative to IPsec) from
the possibility of forged TCP Reset, but we feel that this is adequately
dealt with by randomized TCP sequence numbers.
In contrast with other TLS libraries, Plan 9 does not
require the application to change
</span><span style="font-size: 10pt"><tt>write</tt></span><span style="font-size: 10pt">
calls to
</span><span style="font-size: 10pt"><tt>sslwrite</tt></span><span style="font-size: 10pt">
but simply to add a few lines of code at startup
[Resc01].
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>8.
Conclusion
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Writing safe code is difficult.
Stack attacks,
mistakes in logic, and bugs in compilers and operating systems
can each make it possible for an attacker
to subvert the intended execution sequence of a
service.
If the server process has the privileges
of a powerful user, such as
</span><span style="font-size: 10pt"><tt>root</tt></span><span style="font-size: 10pt">
on Unix, then so does the attacker.
</span><span style="font-size: 10pt"><tt>Factotum</tt></span><span style="font-size: 10pt">
allows us
to constrain the privileged execution to a single
process whose core is a few thousand lines of code.
Verifying such a process, both through manual and automatic means,
is much easier and less error prone
than requiring it of all servers.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">An implementation of these ideas is in Plan 9 from Bell Labs, Fourth Edition,
freely available from </span><span style="font-size: 10pt"><tt>http://plan9.bell-labs.com/plan9</tt></span><span style="font-size: 10pt">.
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>Acknowledgments
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">William Josephson contributed to the implementation of password changing in
</span><span style="font-size: 10pt"><tt>secstore</tt></span><span style="font-size: 10pt">.
We thank Phil MacKenzie and Mart&iacute;n Abadi for helpful comments on early parts
of the design.
Chuck Blake,
Peter Bosch,
Frans Kaashoek,
Sape Mullender,
and
Lakshman Y. N.,
predominantly Dutchmen, gave helpful comments on the paper.
Russ Cox is supported by a fellowship from the Fannie and John Hertz Foundation.
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>References
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">[Bell93]
S.M. Bellovin and M. Merritt,
&lsquo;&lsquo;Augmented Encrypted Key Exchange,&rsquo;&rsquo;
Proceedings of the 1st ACM Conference on Computer and Communications Security, 1993, pp. 244 - 250.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">[Boyk00]
Victor Boyko, Philip MacKenzie, and Sarvar Patel,
&lsquo;&lsquo;Provably Secure Password-Authenticated Key Exchange using Diffie-Hellman,&rsquo;&rsquo;
Eurocrypt 2000, 156-171.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">[RFC2246]
T . Dierks and C. Allen,
&lsquo;&lsquo;The TLS Protocol, Version 1.0,&rsquo;&rsquo;
RFC 2246.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">[Ford00]
Warwick Ford and Burton S. Kaliski, Jr.,
&lsquo;&lsquo;Server-Assisted Generation of a Strong Secret from a Password,&rsquo;&rsquo;
IEEE Fifth International Workshop on Enterprise Security,
National Institute of Standards and Technology (NIST),
Gaithersburg MD, June 14 - 16, 2000.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">[Jabl]
David P. Jablon,
&lsquo;&lsquo;Strong Password-Only Authenticated Key Exchange,&rsquo;&rsquo;
</span><span style="font-size: 10pt"><tt>http://integritysciences.com/speke97.html</tt></span><span style="font-size: 10pt">.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">[Kami00]
Michael Kaminsky.
&lsquo;&lsquo;Flexible Key Management with SFS Agents,&rsquo;&rsquo;
Master&rsquo;s Thesis, MIT, May 2000.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">[Mack]
Philip MacKenzie,
private communication.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">[Mazi99]
David Mazi&egrave;res, Michael Kaminsky, M. Frans Kaashoek and Emmett Witchel,
&lsquo;&lsquo;Separating key management from file system security,&rsquo;&rsquo;
Symposium on Operating Systems Principles, 1999, pp. 124-139.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">[Micr]
Microsoft Passport,
</span><span style="font-size: 10pt"><tt>http://www.passport.com/</tt></span><span style="font-size: 10pt">.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">[Perl99]
Radia Perlman and Charlie Kaufman,
&lsquo;&lsquo;Secure Password-Based Protocol for Downloading a Private Key,&rsquo;&rsquo;
Proc. 1999 Network and Distributed System Security Symposium,
Internet Society, January 1999.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">[Pike95]
Rob Pike, Dave Presotto, Sean Dorward, Bob Flandrena, Ken Thompson, Howard Trickey, and Phil Winterbottom,
&lsquo;&lsquo;Plan 9 from Bell Labs,&rsquo;&rsquo;
Computing Systems, </span><span style="font-size: 10pt"><b>8</b></span><span style="font-size: 10pt">, 3, Summer 1995, pp. 221-254.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">[Pike93]
Rob Pike, Dave Presotto, Ken Thompson, Howard Trickey, Phil Winterbottom,
&lsquo;&lsquo;The Use of Name Spaces in Plan 9,&rsquo;&rsquo;
Operating Systems Review, </span><span style="font-size: 10pt"><b>27</b></span><span style="font-size: 10pt">, 2, April 1993, pp. 72-76
(reprinted from Proceedings of the 5th ACM SIGOPS European Workshop,
Mont Saint-Michel, 1992, Paper n&ordm; 34).
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">[Resc01]
Eric Rescorla,
&lsquo;&lsquo;SSL and TLS: Designing and Building Secure Systems,&rsquo;&rsquo;
Addison-Wesley, 2001. ISBN 0-201-61598-3, p. 387.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">[RFC2138]
C. Rigney, A. Rubens, W. Simpson, S. Willens,
&lsquo;&lsquo;Remote Authentication Dial In User Service (RADIUS),&rsquo;&rsquo;
RFC2138, April 1997.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">[RiLa]
Ronald L. Rivest and Butler Lampson,
&lsquo;&lsquo;SDSI&mdash;A Simple Distributed Security Infrastructure,&rsquo;&rsquo;
</span><span style="font-size: 10pt"><tt>http://theory.lcs.mit.edu/~rivest/sdsi10.ps</tt></span><span style="font-size: 10pt">.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">[Schn]
Bruce Schneier, Password Safe,
</span><span style="font-size: 10pt"><tt>http://www.counterpane.com/passsafe.html</tt></span><span style="font-size: 10pt">.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">[Sama96]
Vipin Samar,
&lsquo;&lsquo;Unified Login with Pluggable Authentication Modules (PAM),&rsquo;&rsquo;
Proceedings of the Third ACM Conference on Computer Communications and Security,
March 1996, New Delhi, India.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">[Stei88]
Jennifer G. Steiner, Clifford Neumann, and Jeffrey I. Schiller,
&lsquo;&lsquo;</span><span style="font-size: 10pt"><i>Kerberos</i></span><span style="font-size: 10pt">: An Authentication Service for Open Network Systems,&rsquo;&rsquo;
Proceedings of USENIX Winter Conference, Dallas, Texas, February 1988, pp. 191-202.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">[Wu98]
T. Wu,
&lsquo;&lsquo;The Secure Remote Password Protocol,&rsquo;&rsquo;
Proceedings of
the 1998 Internet Society Network and Distributed System Security
Symposium, San Diego, CA, March 1998, pp. 97-111.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">[Ylon96]
Ylonen, T.,
&lsquo;&lsquo;SSH&mdash;Secure Login Connections Over the Internet,&rsquo;&rsquo;
6th USENIX Security Symposium, pp. 37-42. San Jose, CA, July 1996.
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>Appendix: Summary of the PAK protocol
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Let </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>q&gt;</i></span><span style="font-size: 11pt"></span><span style="font-size: 11pt">2</span><span style="font-size: 11pt"><sup></sup></span><sup><span style="font-size: 8pt"></span><span style="font-size: 8pt">160</span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sup><span style="font-size: 11pt"></span><span style="font-size: 10pt"> and </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>p&gt;</i></span><span style="font-size: 11pt"></span><span style="font-size: 11pt">2</span><span style="font-size: 11pt"><sup></sup></span><sup><span style="font-size: 8pt"></span><span style="font-size: 8pt">1024</span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sup><span style="font-size: 11pt"></span><span style="font-size: 10pt"> be primes
</span><span style="font-size: 10pt">such that </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>p</i></span><span style="font-size: 11pt">=</span><span style="font-size: 11pt"><i>rq</i></span><span style="font-size: 11pt">+</span><span style="font-size: 11pt"><i></i></span><span style="font-size: 11pt"></span><span style="font-size: 11pt">1</span><span style="font-size: 11pt"></span><span style="font-size: 10pt"> with </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>r</i></span><span style="font-size: 11pt"></span><span style="font-size: 10pt"> not a multiple of </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>q</i></span><span style="font-size: 11pt"></span><span style="font-size: 10pt">.
</span><span style="font-size: 10pt">Take </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>h</i></span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>&isin;</i></span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>Z</i></span><span style="font-size: 11pt"></span><span style="font-size: 8pt"><sub></sub></span><sub><span style="font-size: 8pt"><i>p</i></span><span style="font-size: 8pt"></span></sub><span style="font-size: 8pt"><sup></sup></span><sup><span style="font-size: 8pt"><i>*</i></span><span style="font-size: 8pt"></span></sup><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span><span style="font-size: 10pt"> such that </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>g</i></span><span style="font-size: 11pt">&equiv;</span><span style="font-size: 11pt"><i>h</i></span><span style="font-size: 11pt"><sup></sup></span><sup><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i>r</i></span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sup><span style="font-size: 11pt"></span><span style="font-size: 10pt"> is not 1.
These parameters may be chosen by the NIST algorithm for DSA,
and are public, fixed values.
</span><span style="font-size: 10pt">The client </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>C</i></span><span style="font-size: 11pt"></span><span style="font-size: 10pt"> knows a secret </span><span style="font-size: 11pt">&pi;</span><span style="font-size: 10pt">
</span><span style="font-size: 10pt">and computes </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>H</i></span><span style="font-size: 11pt">&equiv;</span><span style="font-size: 11pt">(</span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>H</i></span><span style="font-size: 11pt"><sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 8pt">1</span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sub><span style="font-size: 11pt"></span><span style="font-size: 11pt">(</span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>C</i></span><span style="font-size: 11pt"></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"> &pi;</span><span style="font-size: 11pt">)</span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i></i></span><span style="font-size: 11pt"></span><span style="font-size: 11pt">)</span><span style="font-size: 11pt"><sup></sup></span><sup><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i>r</i></span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sup><span style="font-size: 11pt"></span><span style="font-size: 10pt"> and </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>H</i></span><span style="font-size: 11pt"><sup></sup></span><sup><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i></i></span><span style="font-size: 8pt">&minus;</span><span style="font-size: 8pt"><i></i></span><span style="font-size: 8pt"></span><span style="font-size: 8pt">1</span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sup><span style="font-size: 11pt"></span><span style="font-size: 10pt">,
</span><span style="font-size: 10pt">where </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>H</i></span><span style="font-size: 11pt"><sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 8pt">1</span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sub><span style="font-size: 11pt"></span><span style="font-size: 10pt"> is a hash function yielding a random element of </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>Z</i></span><span style="font-size: 11pt"></span><span style="font-size: 8pt"><sub></sub></span><sub><span style="font-size: 8pt"><i>p</i></span><span style="font-size: 8pt"></span></sub><span style="font-size: 8pt"><sup></sup></span><sup><span style="font-size: 8pt"><i>*</i></span><span style="font-size: 8pt"></span></sup><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span><span style="font-size: 10pt">,
</span><span style="font-size: 10pt">and </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>H</i></span><span style="font-size: 11pt"><sup></sup></span><sup><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i></i></span><span style="font-size: 8pt">&minus;</span><span style="font-size: 8pt"><i></i></span><span style="font-size: 8pt"></span><span style="font-size: 8pt">1</span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sup><span style="font-size: 11pt"></span><span style="font-size: 10pt"> may be computed by gcd.
</span><span style="font-size: 10pt">(All arithmetic is modulo </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>p</i></span><span style="font-size: 11pt"></span><span style="font-size: 10pt">.)
</span><span style="font-size: 10pt">The client gives </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>H</i></span><span style="font-size: 11pt"><sup></sup></span><sup><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i></i></span><span style="font-size: 8pt">&minus;</span><span style="font-size: 8pt"><i></i></span><span style="font-size: 8pt"></span><span style="font-size: 8pt">1</span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sup><span style="font-size: 11pt"></span><span style="font-size: 10pt"> to the server </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>S</i></span><span style="font-size: 11pt"></span><span style="font-size: 10pt"> ahead of time by a private channel.
</span><span style="font-size: 10pt">To start a new connection, the client generates a random value </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>x</i></span><span style="font-size: 11pt"></span><span style="font-size: 10pt">,
</span><span style="font-size: 10pt">computes </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>m</i></span><span style="font-size: 11pt">&equiv;</span><span style="font-size: 11pt"><i>g</i></span><span style="font-size: 11pt"><sup></sup></span><sup><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i>x</i></span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sup><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>H</i></span><span style="font-size: 11pt"></span><span style="font-size: 10pt">,
</span><span style="font-size: 10pt">then calls the server and sends </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>C</i></span><span style="font-size: 11pt"></span><span style="font-size: 10pt"> and </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>m</i></span><span style="font-size: 11pt"></span><span style="font-size: 10pt">.
</span><span style="font-size: 10pt">The server checks </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>m</i></span><span style="font-size: 11pt">&ne;</span><span style="font-size: 11pt">0</span><span style="font-size: 11pt"> </span><span style="font-size: 11pt">mod</span><span style="font-size: 11pt"> </span><span style="font-size: 11pt"><i>p</i></span><span style="font-size: 11pt"></span><span style="font-size: 10pt">,
</span><span style="font-size: 10pt">generates random </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>y</i></span><span style="font-size: 11pt"></span><span style="font-size: 10pt">,
</span><span style="font-size: 10pt">computes </span><span style="font-size: 11pt">&mu;&equiv;</span><span style="font-size: 11pt"><i>g</i></span><span style="font-size: 11pt"><sup></sup></span><sup><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i>y</i></span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sup><span style="font-size: 11pt"></span><span style="font-size: 10pt">,
</span><span style="font-size: 10pt"></span><span style="font-size: 11pt">&sigma;&equiv;</span><span style="font-size: 11pt">(</span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>m</i></span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>H</i></span><span style="font-size: 11pt"><sup></sup></span><sup><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i></i></span><span style="font-size: 8pt">&minus;</span><span style="font-size: 8pt"><i></i></span><span style="font-size: 8pt"></span><span style="font-size: 8pt">1</span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sup><span style="font-size: 11pt"></span><span style="font-size: 11pt">)</span><span style="font-size: 11pt"><sup></sup></span><sup><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i>y</i></span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sup><span style="font-size: 11pt"></span><span style="font-size: 10pt">,
</span><span style="font-size: 10pt">and sends </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>S</i></span><span style="font-size: 11pt"></span><span style="font-size: 10pt">, </span><span style="font-size: 11pt">&mu;</span><span style="font-size: 10pt">, </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>k</i></span><span style="font-size: 11pt">&equiv;</span><span style="font-size: 11pt"><i>sha1</i></span><span style="font-size: 11pt"></span><span style="font-size: 11pt">(</span><span style="font-size: 11pt"></span><span style="font-size: 11pt">"server"</span><span style="font-size: 11pt"></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>C</i></span><span style="font-size: 11pt"></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>S</i></span><span style="font-size: 11pt"></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>m</i></span><span style="font-size: 11pt"></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt">&mu;</span><span style="font-size: 11pt">,</span><span style="font-size: 11pt">&sigma;</span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>H</i></span><span style="font-size: 11pt"><sup></sup></span><sup><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i></i></span><span style="font-size: 8pt">&minus;</span><span style="font-size: 8pt"><i></i></span><span style="font-size: 8pt"></span><span style="font-size: 8pt">1</span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sup><span style="font-size: 11pt"></span><span style="font-size: 11pt">)</span><span style="font-size: 11pt"></span><span style="font-size: 10pt">.
</span><span style="font-size: 10pt">Next the client computes </span><span style="font-size: 11pt">&sigma;</span><span style="font-size: 11pt"><i></i></span><span style="font-size: 11pt">=</span><span style="font-size: 11pt"><i></i></span><span style="font-size: 11pt">&mu;<sup></sup></span><sup><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i>x</i></span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sup><span style="font-size: 11pt"></span><span style="font-size: 10pt">,
</span><span style="font-size: 10pt">verifies </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>k</i></span><span style="font-size: 11pt"></span><span style="font-size: 10pt">,
</span><span style="font-size: 10pt">and sends </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>k<sup>&prime;</sup></i></span><span style="font-size: 11pt">&equiv;</span><span style="font-size: 11pt"><i>sha1</i></span><span style="font-size: 11pt"></span><span style="font-size: 11pt">(</span><span style="font-size: 11pt"></span><span style="font-size: 11pt">"client"</span><span style="font-size: 11pt"></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>C</i></span><span style="font-size: 11pt"></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>S</i></span><span style="font-size: 11pt"></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>m</i></span><span style="font-size: 11pt"></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt">&mu;</span><span style="font-size: 11pt">,</span><span style="font-size: 11pt">&sigma;</span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>H</i></span><span style="font-size: 11pt"><sup></sup></span><sup><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i></i></span><span style="font-size: 8pt">&minus;</span><span style="font-size: 8pt"><i></i></span><span style="font-size: 8pt"></span><span style="font-size: 8pt">1</span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sup><span style="font-size: 11pt"></span><span style="font-size: 11pt">)</span><span style="font-size: 11pt"></span><span style="font-size: 10pt">.
</span><span style="font-size: 10pt">The server then verifies </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>k<sup>&prime;</sup></i></span><span style="font-size: 11pt"></span><span style="font-size: 10pt"> and both sides begin
</span><span style="font-size: 10pt">using session key </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>K</i></span><span style="font-size: 11pt">&equiv;</span><span style="font-size: 11pt"><i>sha1</i></span><span style="font-size: 11pt"></span><span style="font-size: 11pt">(</span><span style="font-size: 11pt"></span><span style="font-size: 11pt">"session"</span><span style="font-size: 11pt"></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>C</i></span><span style="font-size: 11pt"></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>S</i></span><span style="font-size: 11pt"></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>m</i></span><span style="font-size: 11pt"></span><span style="font-size: 11pt">,</span><span style="font-size: 11pt">&mu;</span><span style="font-size: 11pt">,</span><span style="font-size: 11pt">&sigma;</span><span style="font-size: 11pt">,</span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>H</i></span><span style="font-size: 11pt"><sup></sup></span><sup><span style="font-size: 8pt"></span><span style="font-size: 8pt"><i></i></span><span style="font-size: 8pt">&minus;</span><span style="font-size: 8pt"><i></i></span><span style="font-size: 8pt"></span><span style="font-size: 8pt">1</span><span style="font-size: 8pt"></span><span style="font-size: 11pt"></span></sup><span style="font-size: 11pt"></span><span style="font-size: 11pt">)</span><span style="font-size: 11pt"></span><span style="font-size: 10pt">.
</span><span style="font-size: 10pt">In the published version of PAK, the server name </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>S</i></span><span style="font-size: 11pt"></span><span style="font-size: 10pt">
is included in the initial
</span><span style="font-size: 10pt">hash </span><span style="font-size: 11pt"></span><span style="font-size: 11pt"><i>H</i></span><span style="font-size: 11pt"></span><span style="font-size: 10pt">, but doing so is inconvenient in our application,
as the server may be known by various equivalent names.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">MacKenzie has shown
[Mack]
that the
equivalence proof [Boyk00]
can be adapted to cover our version.
</span></p><p style="margin-top: 0; margin-bottom: 0.50in"></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.50in; text-indent: 0.00in; margin-right: 1.50in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"></span><span style="font-size: 10pt"><b>Notes</b></span><span style="font-size: 10pt">
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.2em; margin-left: 1.50in; text-indent: 0.00in; margin-right: 1.50in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Appeared, in a slightly different form, in
</span><span style="font-size: 10pt"><i>Proc. of the 2002 Usenix Security Symposium,
</i></span><span style="font-size: 10pt">San Francisco.
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

</body>
</html>

