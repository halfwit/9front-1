<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv=Content-Type content="text/html; charset=utf8">
<title>The 64-bit Standalone Plan 9 File Server</title>
</meta>
</head>
<body>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.50in"></p>
<p style="margin-top: 0; margin-bottom: 0.21in"></p>

<p style="line-height: 1.4em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: center;">
<span style="font-size: 12pt"><b>The 64-bit Standalone Plan 9 File Server</b></span></p>
<p style="margin-top: 0; margin-bottom: 0.21in"></p>

<p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.4em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: center;">
<span style="font-size: 10pt"><i>Ken Thompson*</i></span></p>
<p style="line-height: 1.4em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: center;">
<span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt"><tt>ken@plan9.bell-labs.com</tt></span><span style="font-size: 10pt"><i></i></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.4em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: center;">
<span style="font-size: 10pt"><i>Geoff Collyer</i></span></p>
<p style="line-height: 1.4em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: center;">
<span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt"><tt>geoff@plan9.bell-labs.com</tt></span><span style="font-size: 10pt"><i></i></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.4em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: center;">
<span style="font-size: 10pt">Bell Laboratories</span></p>
<p style="line-height: 1.4em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: center;">
<span style="font-size: 10pt">Murray Hill, New Jersey 07974</span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.33in"></p>
<p style="line-height: 1.4em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: center;">
<span style="font-size: 10pt"><i>ABSTRACT</i></span></p>
<p style="margin-top: 0; margin-bottom: 0.19in"></p>
<p style="line-height: 1.2em; margin-left: 1.50in; text-indent: 0.35in; margin-right: 1.50in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">This paper is a revision of Thompson&rsquo;s
</span><span style="font-size: 10pt"><i>The Plan 9 File Server</i></span><span style="font-size: 10pt">,
and describes the structure
and the operation of the new 64-bit Plan 9 file servers.
Some specifics apply to the 32-bit
Plan 9 file server
Emelie,
which code is also the basis for
the user-level file server
</span><span style="font-size: 10pt"><tt>kfs</tt></span><span style="font-size: 10pt">.
</span><span style="font-size: 10pt"></span><span style="font-size: 10pt"></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.50in; text-indent: 0.35in; margin-right: 1.50in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">In 2004,
Collyer created a 64-bit version of
Thompson&rsquo;s 32-bit file server, updating all file
offsets, sizes and block numbers to 64 bits.
In addition, triple- and quadruple-indirect
blocks were implemented.
File name components were extended from 27 to 55 bytes.
This code is also the basis for the user-level file server
</span><span style="font-size: 10pt"><i>cwfs</i></span><span style="font-size: 10pt">(4).
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="margin-top: 0; margin-bottom: 0.50in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>Introduction
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.35in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The Plan 9 file server
Emelie
is the oldest piece of system software
still in use on Plan 9.
It evolved from a user-level program that served
serial lines on a Sequent multi-processor.
The current implementation is neither clean nor
portable,
but it has slowly come to terms with
its particular set of cranky computers
and devices.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.35in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The file server
</span><span style="font-size: 10pt"><i>fs64</i></span><span style="font-size: 10pt">
runs a revision of Emelie&rsquo;s code
with 64-bit file sizes, offsets and block numbers
and indirect blocks from single to quadruple.
Actually these are 63-bit values, since the type used is
</span><span style="font-size: 10pt"><i>vlong</i></span><span style="font-size: 10pt">
(signed
</span><span style="font-size: 10pt"><i>long long</i></span><span style="font-size: 10pt">
integer),
but 63 bits should suffice for a little while.
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>Process Structure
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.35in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The Plan 9 file system server is made from
an ancient version of the Plan 9 kernel.
The kernel contains process control,
synchronization,
locks,
and some memory
allocation.
The kernel has no user processes or
virtual memory.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.35in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The structure of the file system server
is a set of kernel processes
synchronizing mostly through message passing.
In
</span><span style="font-size: 10pt"><i>fs64</i></span><span style="font-size: 10pt">
there are 27 processes of 11 types:
</span></p><center><img src="p10.png"></center>
</center>
<p style="margin-top: 0; margin-bottom: 0.02in"></p>

<p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>The server processes
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.35in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The main file system algorithm is a set
of identical processes
named
</span><span style="font-size: 10pt"><tt>srv</tt></span><span style="font-size: 10pt">
that honor the
9P protocol.
Each file system process waits on
a message queue for an incoming request.
The request contains a 9P message and
the address of a reply queue.
A
</span><span style="font-size: 10pt"><tt>srv</tt></span><span style="font-size: 10pt">
process parses the message,
performs pseudo-disk I/O
to the corresponding file system block device,
formulates a response,
and sends the
response back to the reply queue.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.35in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The unit of storage is a
logical block
(not physical sector) of data on a device:
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    enum</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    {</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        RBUFSIZE = 8*1024</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    };</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.15in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    typedef vlong Off;</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    typedef</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    struct</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    {</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        short   pad;</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        short   tag;</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        Off path;</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    } Tag;</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.15in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    enum</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    {</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        BUFSIZE = RBUFSIZE - sizeof(Tag)</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    };</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.15in"></p>

<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    typedef</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    struct</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    {</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        uchar   data[BUFSIZE];</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        Tag tag;</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    } Block;</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">All devices are idealized as a perfect disk
of contiguously numbered blocks each of size
</span><span style="font-size: 10pt"><tt>RBUFSIZE</tt></span><span style="font-size: 10pt">.
Each block has a tag that identifies what type
of block it is and a unique id of the file or directory
where this block resides.
The remaining data in the block depends on
what type of block it is.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.35in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The
</span><span style="font-size: 10pt"><tt>srv</tt></span><span style="font-size: 10pt">
process&rsquo;s main data structure is the directory entry.
This is the equivalent of a UNIX i-node and
defines the set of block addresses that comprise a file or directory.
Unlike the i-node,
the directory entry also has the name of the
file or directory in it:
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    enum</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    {</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        NAMELEN = 56,</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        NDBLOCK = 6,</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        NIBLOCK = 4,</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    };</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    typedef</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    struct</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    {</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        char    name[NAMELEN];</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        short   uid;</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        short   gid;</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        ushort  mode;</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        short   wuid;</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        Qid qid;</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        Off size;</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        Off dblock[NDBLOCK];</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        Off iblocks[NIBLOCK];</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        long    atime;</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        long    mtime;</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    } Dentry;</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Each directory entry holds the file or directory
name, protection mode, access times, user-id, group-id, and addressing
information.
The entry
</span><span style="font-size: 10pt"><tt>wuid</tt></span><span style="font-size: 10pt">
is the user-id of the last writer of the file
and
</span><span style="font-size: 10pt"><tt>size</tt></span><span style="font-size: 10pt">
is the size of the file in bytes.
The addresses of the first 6
blocks of the file are held in the
</span><span style="font-size: 10pt"><tt>dblock</tt></span><span style="font-size: 10pt">
array.
If the file is larger than that,
an indirect block is allocated that holds
the next
</span><span style="font-size: 10pt"><tt>BUFSIZE/sizeof(Off)</tt></span><span style="font-size: 10pt">
block addresses of the file.
The indirect block address is held in
</span><span style="font-size: 10pt"><tt>iblocks[0]</tt></span><span style="font-size: 10pt">.
If the file is larger yet,
then there is a double indirect block that points
at indirect blocks.
The double indirect address is held in
</span><span style="font-size: 10pt"><tt>iblocks[1]</tt></span><span style="font-size: 10pt">
and can point at another
</span><span style="font-size: 10pt"><tt>(BUFSIZE/sizeof(Off))<sup></sup></tt><sup></sup></span><sup><span style="font-size: 8pt"><tt>2</tt></span><span style="font-size: 10pt"><tt></tt></span></sup><span style="font-size: 10pt"><tt></tt></span><span style="font-size: 10pt">
blocks of data.
This is extended through a quadruple indirect block at
</span><span style="font-size: 10pt"><tt>iblocks[3]</tt></span><span style="font-size: 10pt">
but the code is now parameterised to permit easily changing the
number of direct blocks and the depth of indirect blocks,
and also the maximum size of a file name component.
The maximum addressable size of a file is
therefore 7.93 petabytes at a block size of 8k,
but 7.98 exabytes (just under </span><span style="font-size: 10pt">2</span><span style="font-size: 10pt"><sup></sup></span><sup><span style="font-size: 7pt"></span><span style="font-size: 7pt">63</span><span style="font-size: 7pt"></span><span style="font-size: 10pt"></span></sup><span style="font-size: 10pt"> bytes) at a block size of 32k.
File size is restricted to </span><span style="font-size: 10pt">2</span><span style="font-size: 10pt"><sup></sup></span><sup><span style="font-size: 7pt"></span><span style="font-size: 7pt">63</span><span style="font-size: 7pt"></span><span style="font-size: 10pt"></span></sup><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt">&minus;</span><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt"></span><span style="font-size: 10pt">1</span><span style="font-size: 10pt"> bytes in any case
because the length of a file is maintained in a
(signed)
</span><span style="font-size: 10pt"><i>vlong</i></span><span style="font-size: 10pt">.
These numbers are based on
</span><span style="font-size: 10pt"><i>fs64</i></span><span style="font-size: 10pt">
which has a block size of 8k and
</span><span style="font-size: 10pt"><tt>sizeof(Off)</tt></span><span style="font-size: 10pt">
is 8.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.35in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The declarations of the indirect and double indirect blocks
are as follows.
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    enum</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    {</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        INDPERBUF = BUFSIZE/sizeof(Off),</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    };</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    typedef</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    {</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        Off dblock[INDPERBUF];</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        Tag ibtag;</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    } Iblock;</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    typedef</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    {</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        Off iblock[INDPERBUF];</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        Tag dibtag;</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    } Diblock;</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.35in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The root of a file system is a single directory entry
at a known block address.
A directory is a file that consists of a list of
directory entries.
To make access easier,
a directory entry cannot cross blocks.
In
</span><span style="font-size: 10pt"><i>fs64</i></span><span style="font-size: 10pt">
there are 47 directory entries per block.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.35in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The device on which the blocks reside is implicit
and ultimately comes from the 9P
</span><span style="font-size: 10pt"><tt>attach</tt></span><span style="font-size: 10pt">
message that specifies the name of the
device containing the root.
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>Buffer Cache
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.35in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">When the file server is
booted,
all of the unused memory is allocated to
a block buffer pool.
There are two major operations on the buffer
pool.
</span><span style="font-size: 10pt"><tt>Getbuf</tt></span><span style="font-size: 10pt">
will find the buffer associated with a
particular block on a particular device.
The returned buffer is locked so that the
caller has exclusive use.
If the requested buffer is not in the pool,
some other buffer will be relabeled and
the data will be read from the requested device.
</span><span style="font-size: 10pt"><tt>Putbuf</tt></span><span style="font-size: 10pt">
will unlock a buffer and
if the contents are marked as modified,
the buffer will be written to the device before
the buffer is relabeled.
If there is some special mapping
or CPU cache flushing
that must occur in order for the physical I/O
device to access the buffers,
this is done between
</span><span style="font-size: 10pt"><tt>getbuf</tt></span><span style="font-size: 10pt">
and
</span><span style="font-size: 10pt"><tt>putbuf</tt></span><span style="font-size: 10pt">.
The contents of a buffer is never touched
except while it is locked between
</span><span style="font-size: 10pt"><tt>getbuf</tt></span><span style="font-size: 10pt">
and
</span><span style="font-size: 10pt"><tt>putbuf</tt></span><span style="font-size: 10pt">
calls.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.35in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The
file system server processes
prevent deadlock in the buffers by
always locking parent and child
directory entries in that order.
Since the entire directory structure
is a hierarchy,
this makes the locking well-ordered,
preventing deadlock.
The major problem in the locking strategy is
that locks are at a block level and there are many
directory entries in a single block.
There are unnecessary lock conflicts
in the directory blocks.
When one of these directory blocks is tied up
accessing the very slow WORM,
then all I/O to dozens of unrelated directories
is blocked.
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>Block Devices
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.35in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The block device I/O system is like a
protocol stack of filters.
There are a set of pseudo-devices that call
recursively to other pseudo-devices and real devices.
The protocol stack is compiled from a configuration
string that specifies the order of pseudo-devices and devices.
Each pseudo-device and device has a set of entry points
that corresponds to the operations that the file system
requires of a device.
The most notable operations are
</span><span style="font-size: 10pt"><tt>read</tt></span><span style="font-size: 10pt">,
</span><span style="font-size: 10pt"><tt>write</tt></span><span style="font-size: 10pt">,
and
</span><span style="font-size: 10pt"><tt>size</tt></span><span style="font-size: 10pt">.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.35in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The device stack can best be described by
describing the syntax of the configuration string
that specifies the stack.
Configuration strings are used
during the setup of the file system.
For a description see
</span><span style="font-size: 10pt"><i>fsconfig</i></span><span style="font-size: 10pt">(8).
In the following recursive definition,
</span><span style="font-size: 10pt"><i>D</i></span><span style="font-size: 10pt">
represents a
string that specifies a block device.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.35in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>D</i></span><span style="font-size: 10pt"> = (</span><span style="font-size: 10pt"><i>DD</i></span><span style="font-size: 10pt">...)    </span></p><p style="line-height: 1.2em; margin-left: 1.35in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">This is a set of devices that
are concatenated to form a single device.
The size of the catenated device is the
sum of the sizes of each sub-device.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.35in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>D</i></span><span style="font-size: 10pt"> = [</span><span style="font-size: 10pt"><i>DD</i></span><span style="font-size: 10pt">...]    </span></p><p style="line-height: 1.2em; margin-left: 1.35in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">This is the interleaving of the
individual devices.
If there are N devices in the list,
then the pseudo-device is the N-way block
interleaving of the sub-devices.
The size of the interleaved device is
N times the size of the smallest sub-device.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.35in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>D</i></span><span style="font-size: 10pt"> = {</span><span style="font-size: 10pt"><i>DD</i></span><span style="font-size: 10pt">...}    </span></p><p style="line-height: 1.2em; margin-left: 1.35in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">This is a set of devices that
constitute a &lsquo;mirror&rsquo; of the first sub-device, and form a single device.
A write to the device is performed,
at the same block address,
on the sub-devices, in right-to-left order.
A read from the device is performed on each sub-device,
in left-to-right order, until a read succeeds without error,
or the set is exhausted.
One can think of this as a poor man&rsquo;s RAID 1.
The size of the device is the size of the smallest sub-device.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.35in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>D</i></span><span style="font-size: 10pt"> = </span><span style="font-size: 10pt"><tt>p</tt></span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>DN1.N2</i></span><span style="font-size: 10pt">    </span></p><p style="line-height: 1.2em; margin-left: 1.35in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">This is a partition of a sub-device.
The sub-device is partitioned into 100 equal pieces.
If the size of the sub-device is not divisible by 100,
then there will be some slop thrown away at the top.
The pseudo-device starts at the N1-th piece and
continues for N2 pieces. Thus
</span><span style="font-size: 10pt"><tt>p</tt></span><span style="font-size: 10pt"><i>D</i></span><span style="font-size: 10pt"><tt>67.33</tt></span><span style="font-size: 10pt">
will be the
last third of the device
</span><span style="font-size: 10pt"><i>D</i></span><span style="font-size: 10pt">.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.35in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>D</i></span><span style="font-size: 10pt"> = </span><span style="font-size: 10pt"><tt>f</tt></span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>D</i></span><span style="font-size: 10pt"> </span></p><p style="line-height: 1.2em; margin-left: 1.35in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">This is a fake write-once-read-many device simulated by a
second read-write device.
This second device is partitioned
into a set of block flags and a set of blocks.
The flags are used to generate errors if a
block is ever written twice or read without being written first.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.35in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>D</i></span><span style="font-size: 10pt"> = </span><span style="font-size: 10pt"><tt>x</tt></span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>D</i></span><span style="font-size: 10pt"> </span></p><p style="line-height: 1.2em; margin-left: 1.35in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">This is a byte-swapped version of the file system on D.
Since the file server currently writes integers in metadata to disk
in native byte order, moving a file system to a machine of the other
major byte order (e.g., MIPS to Pentium)
requires the use of
</span><span style="font-size: 10pt"><tt>x</tt></span><span style="font-size: 10pt">.
It knows the sizes of the various integer fields in the file system metadata.
Ideally, the file server would follow the Plan 9 religion and write a consistent
byte order on disk, regardless of processor.
In the mean time, it should be possible to automatically determine the need
for byte-swapping by examining data in the super-block of each file system,
though this has not been implemented yet.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.35in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>D</i></span><span style="font-size: 10pt"> = </span><span style="font-size: 10pt"><tt>c</tt></span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>DD</i></span><span style="font-size: 10pt">    </span></p><p style="line-height: 1.2em; margin-left: 1.35in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">This is the cache/WORM device made up of a cache (read-write)
device and a WORM (write-once-read-many) device.
More on this later.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.35in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>D</i></span><span style="font-size: 10pt"> = </span><span style="font-size: 10pt"><tt>o</tt></span><span style="font-size: 10pt">  </span></p><p style="line-height: 1.2em; margin-left: 1.35in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">This is the dump file system that is the
two-level hierarchy of all dumps ever taken on a cache/WORM.
The read-only root of the cache/WORM file system
(on the dump taken Feb 18, 1995) can
be referenced as
</span><span style="font-size: 10pt"><tt>/1995/0218</tt></span><span style="font-size: 10pt">
in this pseudo device.
The second dump taken that day will be
</span><span style="font-size: 10pt"><tt>/1995/02181</tt></span><span style="font-size: 10pt">.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.35in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>D</i></span><span style="font-size: 10pt"> = </span><span style="font-size: 10pt"><tt>w</tt></span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>N1.N2.N3</i></span><span style="font-size: 10pt">  </span></p><p style="line-height: 1.2em; margin-left: 1.35in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">This is a SCSI disk on controller N1, target N2 and logical unit number N3.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.35in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>D</i></span><span style="font-size: 10pt"> = </span><span style="font-size: 10pt"><tt>h</tt></span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>N1.N2.0</i></span><span style="font-size: 10pt">   </span></p><p style="line-height: 1.2em; margin-left: 1.35in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">This is an (E)IDE or *ATA disk on controller N1, target N2
(target 0 is the IDE master, 1 the slave device).
These disks are currently run via programmed I/O, not DMA,
so they tend to be slower to access than SCSI disks.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.35in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>D</i></span><span style="font-size: 10pt"> = </span><span style="font-size: 10pt"><tt>r</tt></span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>N1</i></span><span style="font-size: 10pt">    </span></p><p style="line-height: 1.2em; margin-left: 1.35in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">This is the same as
</span><span style="font-size: 10pt"><tt>w</tt></span><span style="font-size: 10pt">,
but refers to a side of a WORM disc.
See the
</span><span style="font-size: 10pt"><i>j</i></span><span style="font-size: 10pt">
device.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.35in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>D</i></span><span style="font-size: 10pt"> = </span><span style="font-size: 10pt"><tt>l</tt></span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>N1</i></span><span style="font-size: 10pt">    </span></p><p style="line-height: 1.2em; margin-left: 1.35in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">This is the same as
</span><span style="font-size: 10pt"><tt>r</tt></span><span style="font-size: 10pt">,
but one block from the SCSI disk is removed for labeling.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.35in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>D</i></span><span style="font-size: 10pt"> = </span><span style="font-size: 10pt"><tt>j(</tt></span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>D<sub></sub></i><sub></sub></span><sub><span style="font-size: 8pt"><i>1</i></span><span style="font-size: 10pt"><i></i></span></sub><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt"><i>D<sub></sub></i><sub></sub></span><sub><span style="font-size: 8pt"><i>2</i></span><span style="font-size: 10pt"><i></i></span></sub><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt"><tt>*)</tt></span><span style="font-size: 10pt"><i>D<sub></sub></i><sub></sub></span><sub><span style="font-size: 8pt"><i>3</i></span><span style="font-size: 10pt"><i></i></span></sub><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt">  </span></p><p style="line-height: 1.2em; margin-left: 1.35in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>D<sub></sub></i><sub></sub></span><sub><span style="font-size: 8pt"><i>1</i></span><span style="font-size: 10pt"><i></i></span></sub><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt">
is the juke box SCSI interface.
The
<sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 10pt"></span></sub><span style="font-size: 10pt"><sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 10pt"></span></sub><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>D<sub></sub></i><sub></sub></span><sub><span style="font-size: 8pt"><i>2</i></span><span style="font-size: 10pt"><i></i></span></sub><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt">&rsquo;s
are the SCSI drives in the juke box
and the
<sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 10pt"></span></sub><span style="font-size: 10pt"><sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 10pt"></span></sub><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>D<sub></sub></i><sub></sub></span><sub><span style="font-size: 8pt"><i>3</i></span><span style="font-size: 10pt"><i></i></span></sub><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt">&rsquo;s
are the demountable platters in the juke box.
<sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 10pt"></span></sub><span style="font-size: 10pt"><sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 10pt"></span></sub><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>D<sub></sub></i><sub></sub></span><sub><span style="font-size: 8pt"><i>1</i></span><span style="font-size: 10pt"><i></i></span></sub><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt">
and
<sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 10pt"></span></sub><span style="font-size: 10pt"><sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 10pt"></span></sub><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>D<sub></sub></i><sub></sub></span><sub><span style="font-size: 8pt"><i>2</i></span><span style="font-size: 10pt"><i></i></span></sub><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt">
must be
</span><span style="font-size: 10pt"><tt>w</tt></span><span style="font-size: 10pt">.
<sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 10pt"></span></sub><span style="font-size: 10pt"><sub></sub></span><sub><span style="font-size: 8pt"></span><span style="font-size: 10pt"></span></sub><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>D<sub></sub></i><sub></sub></span><sub><span style="font-size: 8pt"><i>3</i></span><span style="font-size: 10pt"><i></i></span></sub><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt">
must be pseudo devices of
</span><span style="font-size: 10pt"><tt>w</tt></span><span style="font-size: 10pt">,
</span><span style="font-size: 10pt"><tt>r</tt></span><span style="font-size: 10pt">,
or
</span><span style="font-size: 10pt"><tt>l</tt></span><span style="font-size: 10pt">
devices.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.35in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">For
</span><span style="font-size: 10pt"><tt>w</tt></span><span style="font-size: 10pt">,
</span><span style="font-size: 10pt"><tt>h</tt></span><span style="font-size: 10pt">,
</span><span style="font-size: 10pt"><tt>l</tt></span><span style="font-size: 10pt">,
and
</span><span style="font-size: 10pt"><tt>r</tt></span><span style="font-size: 10pt">
devices any of the configuration numbers
can be replaced by an iterator of the form
</span><span style="font-size: 10pt"><tt>&lt;</tt></span><span style="font-size: 10pt"><i>N1-N2</i></span><span style="font-size: 10pt"><tt>&gt;</tt></span><span style="font-size: 10pt">.
N1 can be greater than N2, indicating a descending sequence.
Thus
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    [w0.&lt;2-6&gt;]</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">is the interleaved SCSI disks on SCSI targets
2 through 6 of SCSI controller 0.
The main file system on
Emelie
is defined by the configuration string
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    c[w1.&lt;0-5&gt;.0]j(w6w5w4w3w2)(l&lt;0-236&gt;l&lt;238-474&gt;)</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">This is a cache/WORM driver.
The cache is three interleaved disks on SCSI controller 1
targets 0, 1, 2, 3, 4, and 5.
The WORM half of the cache/WORM
is 474 jukebox disks.
Another file server,
</span><span style="font-size: 10pt"><i>choline</i></span><span style="font-size: 10pt">,
has a main file system defined by
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    c[w&lt;1-3&gt;]j(w1.&lt;6-0&gt;.0)(l&lt;0-124&gt;l&lt;128-252&gt;)</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The order of
</span><span style="font-size: 10pt"><tt>w1.&lt;6-0&gt;.0</tt></span><span style="font-size: 10pt">
matters here, since the optical jukebox&rsquo;s WORM drives&rsquo;s
SCSI target ids,
as delivered,
run in descending order relative to the numbers of the drives
in SCSI commands
(e.g., the jukebox controller is SCSI target 6,
drive #1 is SCSI target 5,
and drive #6 is SCSI target 0).
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>The read-ahead processes
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.35in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">There are a set of file system processes,
</span><span style="font-size: 10pt"><tt>rah</tt></span><span style="font-size: 10pt">,
that wait for messages consisting of a device and block
address.
When a message comes in,
the process reads the specified block from the device.
This is done by calling
</span><span style="font-size: 10pt"><tt>getbuf</tt></span><span style="font-size: 10pt">
and
</span><span style="font-size: 10pt"><tt>putbuf</tt></span><span style="font-size: 10pt">.
The purpose of this is the hope that these blocks
will be used later and that they will reside in the
buffer cache long enough not to be discarded before
they are used.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.35in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The messages to the read-ahead processes are
generated by the server processes.
The server processes maintain a relative block mark in every
open file.
Whenever an open file reads that relative block,
the next 110 block addresses of the file are sent
to the read-ahead processes and
the relative block mark is advanced by 100.
The initial relative block is set to 1.
If the file is opened and
only a few bytes are read,
then no anticipating reads are performed
since the relative block mark is set to 1
and only block offset 0 is read.
This is to prevent some
fairly common action such as
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    file *</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">from swamping the file system with read-ahead
requests that will never be used.
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>Cache/WORM Driver
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.35in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The cache/WORM (cw) driver is by far the
largest and most complicated device driver in the file server.
There are four devices involved in the cw driver.
It implements a read/write pseudo-device (the cw-device)
and a read-only pseudo-device (the dump device)
by performing operations on its two constituent devices
the read-write c-device and the write-once-read-many
w-device.
The block numbers on the four devices are distinct,
although the
</span><span style="font-size: 10pt"><i>cw</i></span><span style="font-size: 10pt">
addresses,
dump addresses,
and the
</span><span style="font-size: 10pt"><i>w</i></span><span style="font-size: 10pt">
addresses are
highly correlated.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.35in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The cw-driver uses the w-device as the
stable storage of the file system at the time of the
last dump.
All newly written and a large number of recently used
exact copies of blocks of the w-device are kept on the c-device.
The c-device is much smaller than the w-device and
so the subset of w-blocks that are kept on the c-device are
mapped through a hash table kept on a partition of the c-device.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.35in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The map portion of the c-device consists of blocks of buckets of entries.
The declarations follow.
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    enum</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    {</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        BKPERBLK = 10,</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        CEPERBK = (BUFSIZE - BKPERBLK*sizeof(Off)) /</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>                (sizeof(Centry)*BKPERBLK),</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    };</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    typedef</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    struct</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    {</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        ushort  age;</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        short   state;</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        Off waddr;</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    } Centry;</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    typedef</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    struct</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    {</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        long    agegen;</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        Centry  entry[CEPERBK];</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    } Bucket;</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    Bucket  bucket[BKPERBLK];</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">There is exactly one entry structure for each block in the
data partition of the c-device.
A bucket contains all of the w-addresses that have
the same hash code.
There are as many buckets as will fit
in a block and enough blocks to have the required
number of entries.
The entries in the bucket are maintained
in FIFO order with an age variable and an incrementing age generator.
When the age generator is about to overflow,
all of the ages in the bucket are rescaled
from zero.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.35in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The following steps go into converting a w-address into a c-address.
The bucket is found by
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    bucket_number = w-address % total_buckets;</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    getbuf(c-device, bucket_offset + bucket_number/BKPERBLK);</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">After the desired bucket is found,
the desired entry is found by a linear search within the bucket for the
entry with the desired
</span><span style="font-size: 10pt"><tt>waddr</tt></span><span style="font-size: 10pt">.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.35in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The state variable in the entry is
one of the following.
</span></p><p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    enum</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    {</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        Cnone   = 0,</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        Cdirty,</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        Cdump,</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        Cread,</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        Cwrite,</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>        Cdump1,</tt></span></p>
<p style="line-height: 1.1em; margin-left: 1.28in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 9pt"><tt>    };</tt></span></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="margin-top: 0; margin-bottom: 0.08in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Every w-address has a state.
Blocks that are not in the
c-device have the implied
state
</span><span style="font-size: 10pt"><tt>Cnone</tt></span><span style="font-size: 10pt">.
The
</span><span style="font-size: 10pt"><tt>Cread</tt></span><span style="font-size: 10pt">
state is for blocks that have the
same data as the corresponding block in
the w-device.
Since the c-device is much faster than the
w-device,
</span><span style="font-size: 10pt"><tt>Cread</tt></span><span style="font-size: 10pt">
blocks are kept as long as possible and
used in preference to reading the w-device.
</span><span style="font-size: 10pt"><tt>Cread</tt></span><span style="font-size: 10pt">
blocks may be discarded from the c-device
when the space is needed for newer data.
The
</span><span style="font-size: 10pt"><tt>Cwrite</tt></span><span style="font-size: 10pt">
state is when the c-device contains newer data
than the corresponding block on the w-device.
This happens when a
</span><span style="font-size: 10pt"><tt>Cnone</tt></span><span style="font-size: 10pt">,
</span><span style="font-size: 10pt"><tt>Cread</tt></span><span style="font-size: 10pt">,
or
</span><span style="font-size: 10pt"><tt>Cwrite</tt></span><span style="font-size: 10pt">
block is written.
The
</span><span style="font-size: 10pt"><tt>Cdirty</tt></span><span style="font-size: 10pt">
state
is when the c-device contains
new data and the corresponding block
on the w-device has never been written.
This happens when a new block has been
allocated from the free space on the w-device.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.35in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The
</span><span style="font-size: 10pt"><tt>Cwrite</tt></span><span style="font-size: 10pt">
and
</span><span style="font-size: 10pt"><tt>Cdirty</tt></span><span style="font-size: 10pt">
blocks are created and never removed.
Unless something is done to
convert these blocks,
the c-device will gradually
fill up and stop functioning.
Once a day,
or by command,
a
</span><span style="font-size: 10pt"><i>dump</i></span><span style="font-size: 10pt">
of the cw-device
is taken.
The purpose of
a dump is to queue the writes that
have been shunted to the c-device
to be written to the w-device.
Since the w-device is a WORM,
blocks cannot be rewritten.
Blocks that have already been written to the WORM must be
relocated to the unused portion of the w-device.
These are precisely the
blocks with
</span><span style="font-size: 10pt"><tt>Cwrite</tt></span><span style="font-size: 10pt">
state.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.35in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The dump algorithm is as follows:
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.35in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">a) The tree on the cw-device is walked
as long as the blocks visited have been
modified since the last dump.
These are the blocks with state
</span><span style="font-size: 10pt"><tt>Cwrite</tt></span><span style="font-size: 10pt">
and
</span><span style="font-size: 10pt"><tt>Cdirty</tt></span><span style="font-size: 10pt">.
It is possible to restrict the search
to within these blocks
since the directory containing a modified
file must have been accessed to modify the
file and accessing a directory will set its
modified time thus causing the block containing it
to be written.
The directory containing that directory must be
modified for the same reason.
The tree walk is thus drastically restrained and the
tree walk does not take much time.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.35in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">b) All
</span><span style="font-size: 10pt"><tt>Cwrite</tt></span><span style="font-size: 10pt">
blocks found in the tree search
are relocated to new blank blocks on the w-device
and converted to
</span><span style="font-size: 10pt"><tt>Cdump</tt></span><span style="font-size: 10pt">
state.
All
</span><span style="font-size: 10pt"><tt>Cdirty</tt></span><span style="font-size: 10pt">
blocks are converted to
</span><span style="font-size: 10pt"><tt>Cdump</tt></span><span style="font-size: 10pt">
state without relocation.
At this point,
all modified blocks in the cw-device
have w-addresses that point to unwritten
WORM blocks.
These blocks are marked for later
writing to the w-device
with the state
</span><span style="font-size: 10pt"><tt>Cdump</tt></span><span style="font-size: 10pt">.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.35in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">c) All open files that were pointing to modified
blocks are reopened to point at the corresponding
reallocated blocks.
This causes the directories leading to the
open files to be modified.
Thus the invariant discussed in a) is maintained.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.35in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">d) The background dumping process will slowly
go through the map of the c-device and write out
all blocks with
</span><span style="font-size: 10pt"><tt>Cdump</tt></span><span style="font-size: 10pt">
state.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.35in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The dump takes a few minutes to walk the tree
and mark the blocks.
It can take hours to write the marked blocks
to the WORM.
If a marked block is rewritten before the old
copy has been written to the WORM,
it must be forced to the WORM before it is rewritten.
There is no problem if another dump is taken before the first one
is finished.
The newly marked blocks are just added to the marked blocks
left from the first dump.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.35in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">If there is an error writing a marked block
to the WORM
then the
</span><span style="font-size: 10pt"><tt>dump</tt></span><span style="font-size: 10pt">
state is converted to
</span><span style="font-size: 10pt"><tt>Cdump1</tt></span><span style="font-size: 10pt">
and manual intervention is needed.
(See the
</span><span style="font-size: 10pt"><tt>cwcmd</tt></span><span style="font-size: 10pt">
</span><span style="font-size: 10pt"><tt>mvstate</tt></span><span style="font-size: 10pt">
command in
</span><span style="font-size: 10pt"><i>fs</i></span><span style="font-size: 10pt">(8)).
These blocks can be disposed of by converting
their state back to
</span><span style="font-size: 10pt"><tt>Cdump</tt></span><span style="font-size: 10pt">
so that they will be written again.
They can also be converted to
</span><span style="font-size: 10pt"><tt>Cwrite</tt></span><span style="font-size: 10pt">
state so that they will be allocated new
addresses at the next dump.
In most other respects,
a
</span><span style="font-size: 10pt"><tt>Cdump1</tt></span><span style="font-size: 10pt">
block behaves like a
</span><span style="font-size: 10pt"><tt>Cwrite</tt></span><span style="font-size: 10pt">
block.
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>Sync Copy and WORM Copy Processes
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.35in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The
</span><span style="font-size: 10pt"><tt>scp</tt></span><span style="font-size: 10pt">
process
wakes up every ten seconds and
issues writes to blocks in the buffer cache
that have been modified.
This is done automatically on important
console commands such as
</span><span style="font-size: 10pt"><tt>halt</tt></span><span style="font-size: 10pt">
and
</span><span style="font-size: 10pt"><tt>dump</tt></span><span style="font-size: 10pt">.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.35in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The
</span><span style="font-size: 10pt"><tt>wcp</tt></span><span style="font-size: 10pt">
process also wakes up every ten seconds
and tries to copy a
</span><span style="font-size: 10pt"><tt>dump</tt></span><span style="font-size: 10pt">
block from the cache to the WORM.
As long as there are
</span><span style="font-size: 10pt"><tt>dump</tt></span><span style="font-size: 10pt">
blocks to copy and there is no competition for
the WORM device,
the copy will continue at full speed.
Whenever there is competition for the WORM
or there are no more blocks to
copy,
then the process will sleep ten seconds
before looking again.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.35in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The HP WORM jukebox consists of
238 disks divided into 476 sides
or platters.
Platter 0 is the
</span><span style="font-size: 10pt"><i>A</i></span><span style="font-size: 10pt">
side of disk 0.
Platter 1 is the
</span><span style="font-size: 10pt"><i>A</i></span><span style="font-size: 10pt">
side of the disk 1.
Platter 238 is the
</span><span style="font-size: 10pt"><i>B</i></span><span style="font-size: 10pt">
side of disk 0.
On Emelie,
the main file system is configured
on both sides of the first 237 disks,
platters 0-236 and 238-474.
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>9P Protocol Drivers
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.35in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The file server described so far
waits for 9P protocol messages to
appear in its input queue.
It processes each message and
sends the reply back to the originator.
There are groups of processes that
perform protocol I/O on some network or
device and the resulting messages
are sent to the file system queue.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.35in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">There are two sets of processes
</span><span style="font-size: 10pt"><tt>ethi</tt></span><span style="font-size: 10pt">
and
</span><span style="font-size: 10pt"><tt>etho</tt></span><span style="font-size: 10pt">
that perform Ethernet input and output on two different networks.
These processes send Ethernet messages
to/from two more processes
</span><span style="font-size: 10pt"><tt>ilo</tt></span><span style="font-size: 10pt">
and
</span><span style="font-size: 10pt"><tt>ilt</tt></span><span style="font-size: 10pt">
that do the IL reliable datagram protocol
on top of IP packets.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.35in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The last process in Emelie,
</span><span style="font-size: 10pt"><tt>con</tt></span><span style="font-size: 10pt">,
reads the console
and calls internal subroutines to
executes commands typed.
Since there is only one process,
only one command can be executing at a
time.
See
</span><span style="font-size: 10pt"><i>fs</i></span><span style="font-size: 10pt">(8)
for a description of the
commands available at the console.
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>Acknowledgements
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.35in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Ken Thompson created the Plan 9 file server
and maintained it for many years.
The cached WORM driver is based upon
Sean Quinlan&rsquo;s PhD. thesis and prototype.
Jim McKie maintained the IBM-PC-dependent code,
a thankless job.
Bruce Ellis modified the
</span><span style="font-size: 10pt"><i>8c</i></span><span style="font-size: 10pt">
compiler in 2004
to generate much faster code for common
</span><span style="font-size: 10pt"><i>vlong</i></span><span style="font-size: 10pt">
operations, which made the 64-bit file server feasible.
Nigel Roles contributed support for the APC UPS
and the NCR/Symbios/LSI-Logic SCSI host adaptors.
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>References
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.35in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">[1]    Sean Quinlan, &lsquo;&lsquo;A Cached WORM File System,&rsquo;&rsquo;
</span><span style="font-size: 10pt"><i>Software&mdash;Practice and Experience</i></span><span style="font-size: 10pt">,
Vol 21., No 12., December 1991, pp. 1289-1299.
</span></p><p style="margin-top: 0; margin-bottom: 0.17in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt"><b>Appendix:
Maximum File Sizes in the 64-bit File Server
</b></span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.35in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">The maximum size of a single file in a Plan 9 file server&rsquo;s
file system with 64-bit block numbers
is determined by the file system block size
(there are single, double, triple and quadruple indirect blocks).
The maximum size is thus
</span><span style="font-size: 10pt"><i>d</i></span><span style="font-size: 10pt"></span><span style="font-size: 10pt">(</span><span style="font-size: 10pt"></span><span style="font-size: 10pt">6</span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt">+</span><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>x</i></span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt">+</span><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>x</i></span><span style="font-size: 10pt"><sup></sup></span><sup><span style="font-size: 7pt"></span><span style="font-size: 7pt">2</span><span style="font-size: 7pt"></span><span style="font-size: 10pt"></span></sup><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt">+</span><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>x</i></span><span style="font-size: 10pt"><sup></sup></span><sup><span style="font-size: 7pt"></span><span style="font-size: 7pt">3</span><span style="font-size: 7pt"></span><span style="font-size: 10pt"></span></sup><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt">+</span><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>x</i></span><span style="font-size: 10pt"><sup></sup></span><sup><span style="font-size: 7pt"></span><span style="font-size: 7pt">4</span><span style="font-size: 7pt"></span><span style="font-size: 10pt"></span></sup><span style="font-size: 10pt"></span><span style="font-size: 10pt">)</span><span style="font-size: 10pt">
bytes, where
</span><span style="font-size: 10pt"><i>d</i></span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt">=</span><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i>blocksize</i></span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt">&minus;</span><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt"></span><span style="font-size: 10pt">(</span><span style="font-size: 10pt"></span><span style="font-size: 10pt">2</span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt">+</span><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt"></span><span style="font-size: 10pt">2</span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt">+</span><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt"></span><span style="font-size: 10pt">8</span><span style="font-size: 10pt"></span><span style="font-size: 10pt">)</span><span style="font-size: 10pt">
and
x&rsquo;0-0.85m&rsquo;</span><span style="font-size: 10pt"><i>x</i></span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt">=</span><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt"><sub>b&rsquo;&#65533;&#65533;&#65533;&rsquo;</sub><sub></sub></span><sub><span style="font-size: 10pt">8</span><span style="font-size: 10pt"></span></sub><span style="font-size: 10pt"><sup></sup></span><sup><span style="font-size: 10pt"><i>d</i></span><span style="font-size: 10pt"></span></sup><span style="font-size: 10pt"><sup>l&rsquo;50u-0.2m&rsquo;</sup><sub>b&rsquo;&#65533;&#65533;&#65533;&rsquo;</sub>x&rsquo;1.05m&rsquo;,
8 being the size in bytes of a
</span><span style="font-size: 10pt"><i>long long</i></span><span style="font-size: 10pt">
block number.
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<p style="line-height: 1.2em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: justify;">
<span style="font-size: 10pt">Note that
</span><span style="font-size: 10pt">2</span><span style="font-size: 10pt"><sup></sup></span><sup><span style="font-size: 7pt"></span><span style="font-size: 7pt">63</span><span style="font-size: 7pt"></span><span style="font-size: 10pt"></span></sup><span style="font-size: 10pt"> </span><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt">=</span><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt"> </span><span style="font-size: 10pt">9</span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt"></span><span style="font-size: 10pt">,</span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt"></span><span style="font-size: 10pt">223</span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt"></span><span style="font-size: 10pt">,</span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt"></span><span style="font-size: 10pt">372</span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt"></span><span style="font-size: 10pt">,</span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt"></span><span style="font-size: 10pt">036</span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt"></span><span style="font-size: 10pt">,</span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt"></span><span style="font-size: 10pt">854</span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt"></span><span style="font-size: 10pt">,</span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt"></span><span style="font-size: 10pt">775</span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt"></span><span style="font-size: 10pt">,</span><span style="font-size: 10pt"></span><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt"></span><span style="font-size: 10pt">808</span><span style="font-size: 10pt"> </span><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt">=</span><span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt"> </span><span style="font-size: 10pt">8</span><span style="font-size: 10pt">
EB (binary exabytes).
</span></p><p style="margin-top: 0; margin-bottom: 0.05in"></p>
<center><img src="pa1.png"></center>
</center>
<p style="margin-top: 0; margin-bottom: 0.02in"></p>

<p style="margin-top: 0; margin-bottom: 0.50in"></p>
<p style="margin-top: 0; margin-bottom: 0.19in"></p>
<p style="line-height: 1.4em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: center;">
<span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt"><b>Notes</b></span><span style="font-size: 10pt"><i></i></span></p>
<p style="margin-top: 0; margin-bottom: 0.19in"></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

<p style="line-height: 1.4em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: center;">
<span style="font-size: 10pt"><i>l&rsquo;4i&rsquo;</i></span></p>
<p style="line-height: 1.4em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: center;">
<span style="font-size: 10pt"><i>* now</i></span></p>
<p style="line-height: 1.4em; margin-left: 1.00in; text-indent: 0.00in; margin-right: 1.00in; margin-top: 0; margin-bottom: 0; text-align: center;">
<span style="font-size: 10pt"><i></i></span><span style="font-size: 10pt"><tt>ken@google.com</tt></span><span style="font-size: 10pt"><i></i></span></p>
<p style="margin-top: 0; margin-bottom: 0.19in"></p>
<p style="margin-top: 0; margin-bottom: 0.17in"></p>

</body>
</html>

